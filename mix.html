<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sterling Studio Pro</title>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css'>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=Bebas+Neue&display=swap');
:root {
  --bg:#080810; --bg2:#0d0d1a; --bg3:#121222; --surface:#181830;
  --surface2:#1e1e38; --surface3:#252545;
  --accent:#00d4ff; --accent2:#00d4ff; --accent3:#00d4ff; --accent4:#00d4ff;
  --text:#f0f0ff; --text2:#7070a0; --text3:#404070;
  --border:#252540; --border2:#303060;
  --green:#00d4ff; --red:#00d4ff; --orange:#00d4ff; --yellow:#00d4ff;
  --clip1:#e8ff0022; --clip1b:#00d4ff;
  --clip2:#ff2d6b22; --clip2b:#00d4ff;
  --clip3:#00d4ff22; --clip3b:#00d4ff;
  --clip4:#b400ff22; --clip4b:#00d4ff;
  --clip5:#00ff8822; --clip5b:#00d4ff;
  --clip6:#ff880022; --clip6b:#00d4ff;
  --header-h:54px; --fx-h:44px;
  --mixer-h:280px; --toolbar-h:40px;
  --track-header-w:230px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg)}
body{font-family:'DM Mono',monospace;color:var(--text);font-size:12px;display:flex;flex-direction:column}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
#header{
  height:var(--header-h);background:linear-gradient(90deg,#08081a,#12082a,#08081a);
  border-bottom:1px solid var(--border2);display:flex;align-items:center;
  padding:0 12px;gap:10px;flex-shrink:0;position:relative;z-index:50;
  flex-wrap:nowrap;overflow:hidden;
}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:5px;
  color:var(--accent);text-shadow:0 0 20px rgba(232,255,0,0.4);white-space:nowrap;flex-shrink:0}
.logo em{color:var(--accent2);font-style:normal}
.transport{display:flex;align-items:center;gap:5px;flex-shrink:0}
.tbtn{background:var(--surface);border:1px solid var(--border2);color:var(--text2);
  padding:5px 10px;border-radius:10px;cursor:pointer;font-family:'DM Mono',monospace;
  font-size:11px;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.tbtn:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,255,0,0.05)}
.tbtn.on{background:rgba(232,255,0,0.1);border-color:var(--accent);color:var(--accent);
  box-shadow:0 0 8px rgba(232,255,0,0.2)}
.tbtn.rec-on{background:rgba(255,45,107,0.15);border-color:var(--accent2);color:var(--accent2);
  animation:recblink 1s ease infinite}
@keyframes recblink{0%,100%{opacity:1}50%{opacity:.4}}
.tbtn.export-btn{border-color:var(--accent3);color:var(--accent3)}
.tbtn.export-btn:hover{background:rgba(0,212,255,0.1)}

.bpm-box{display:flex;align-items:center;gap:4px;background:var(--bg2);
  border:1px solid var(--border2);border-radius:30px;padding:3px 8px;flex-shrink:0}
.bpm-box label{font-size:9px;color:var(--text3);letter-spacing:1px}
.bpm-num{font-family:'Bebas Neue';font-size:1.3rem;color:var(--accent3);min-width:44px;text-align:center;cursor:default}
.bpm-box button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px;line-height:1;padding:0 2px}
.bpm-box button:hover{color:var(--accent3)}
#bpmSlider{-webkit-appearance:none;width:80px;height:3px;background:var(--border2);border-radius:30px;outline:none;cursor:pointer}
#bpmSlider::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent3);border-radius:50%}

.time-box{font-family:'Bebas Neue';font-size:1.1rem;color:var(--yellow);
  background:var(--bg);border:1px solid var(--border2);padding:3px 10px;
  border-radius:60px;min-width:88px;text-align:center;letter-spacing:2px;flex-shrink:0}

.sig-box{display:flex;align-items:center;gap:4px;flex-shrink:0}
.sig-box label{font-size:9px;color:var(--text3)}
.sig-box select{background:var(--bg2);border:1px solid var(--border2);color:var(--text);
  padding:3px 6px;border-radius:60px;font-family:'DM Mono',monospace;font-size:11px}

.header-spacer{flex:1}

/* ‚îÄ‚îÄ FX BAR ‚îÄ‚îÄ */
#fxbar{height:var(--fx-h);background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 10px;gap:30px;flex-shrink:0;overflow-x:auto;
  transition:height .25s ease,opacity .25s ease;position:relative;height: 70px;}
#fxbar.collapsed{height:0;opacity:0;overflow:hidden}
.fx-group{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.fx-lbl{font-size:8px;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
.fx-row{display:flex;align-items:center;gap:5px}
.fx-knob-wrap{display:flex;flex-direction:column;align-items:center;gap:1px}
.fx-knob{width:32px;height:32px;background:var(--surface);border:1px solid var(--border2);
  border-radius:50%;cursor:pointer;position:relative;flex-shrink:0;touch-action:none}
.fx-knob::before{content:'';position:absolute;width:3px;height:10px;background:var(--accent);
  border-radius:2px;left:50%;top:4px;transform-origin:bottom center;transform:translateX(-50%) rotate(0deg);transition:none}
.fx-knob-lbl{font-size:8px;color:var(--text3);text-align:center;width:36px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fx-slider{-webkit-appearance:none;width:80px;height:3px;background:var(--border2);border-radius:2px;outline:none;cursor:pointer}
.fx-slider::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent2)}
.fx-sep{width:1px;height:32px;background:var(--border2);flex-shrink:0}
.fx-toggle{background:var(--bg3);border:1px solid var(--border2);color:var(--text2);
  padding:2px 7px;border-radius:3px;cursor:pointer;font-size:9px;font-family:'DM Mono'}
.fx-toggle.on{border-color:var(--accent);color:var(--accent);background:rgba(232,255,0,0.07)}
#fxbar-toggle{position:absolute;right:6px;top:50%;transform:translateY(-50%);
  background:none;border:none;color:var(--text3);cursor:pointer;font-size:10px;padding:4px}
#fxbar-toggle:hover{color:var(--text)}

/* ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ */
#main{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0}
#timeline-area{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0}

/* ‚îÄ‚îÄ RULER ‚îÄ‚îÄ */
#ruler-row{display:flex;height:24px;flex-shrink:0;background:var(--bg2);border-bottom:1px solid var(--border)}
#ruler-corner{width:var(--track-header-w);min-width:var(--track-header-w);
  border-right:1px solid var(--border2);display:flex;align-items:center;justify-content:center}
#ruler-corner-inner{display:flex;gap:4px}
#ruler-scroll{flex:1;overflow:hidden;position:relative}
#ruler-canvas{display:block;height:24px;cursor:pointer}

/* ‚îÄ‚îÄ TRACKS ‚îÄ‚îÄ */
#tracks-outer{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;position:relative}
#tracks-scroll{flex:1;overflow-y:auto;overflow-x:hidden}
.track-row{display:flex;align-items:stretch;border-bottom:1px solid var(--border);
  height:82px;position:relative;flex-shrink:0}
.track-row.dragging-over .track-lane{background:rgba(232,255,0,0.03);border:1px dashed var(--accent)}

/* ‚îÄ‚îÄ TRACK HEADER ‚îÄ‚îÄ */
.track-head{width:var(--track-header-w);min-width:var(--track-header-w);
  background:var(--surface);border-right:1px solid var(--border2);
  display:flex;flex-direction:column;justify-content:space-between;
  padding:5px 7px;gap:3px;width: 230px;position:relative;flex-shrink:0}
.th-top{display:flex;align-items:center;gap:5px}
.th-color{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:1px}
.th-name{font-size:11px;font-family:'Syne',sans-serif;font-weight:600;
  color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;
  white-space:nowrap;cursor:text;outline:none;min-width:0}
.th-name:focus{background:rgba(255,255,255,0.05);border-radius:2px;padding:0 2px}
.th-btns{display:flex;gap:3px;align-items:center}
.th-btn{background:var(--bg2);border:1px solid var(--border);color:var(--text3);
  font-size:8px;font-weight:100;padding:2px 5px;border-radius:60px;cursor:pointer;
  transition:all .1s;font-family:'DM Mono';line-height:1.4}
.th-btn:hover{border-color:var(--accent3);color:var(--accent3)}
.th-btn.muted{background:rgba(255,51,85,0.15);border-color:var(--red);color:var(--red)}
.th-btn.soloed{background:rgba(255,215,0,0.15);border-color:var(--yellow);color:var(--yellow)}
.th-btn.del:hover{border-color:var(--red);color:var(--red)}

.vol-row{display:flex;align-items:center;gap:4px}
.vol-lbl{font-size:9px;color:var(--text3);width:22px;flex-shrink:0}
.vol-sl{-webkit-appearance:none;flex:1;height:3px;background:var(--border2);border-radius:2px;outline:none;cursor:pointer}
.vol-sl::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;cursor:grab}
.vol-val{font-size:9px;width:28px;text-align:right;flex-shrink:0}

#vol-sl-0::-webkit-slider-thumb{background:var(--clip1b)}
#vol-sl-1::-webkit-slider-thumb{background:var(--clip2b)}
#vol-sl-2::-webkit-slider-thumb{background:var(--clip3b)}
#vol-sl-3::-webkit-slider-thumb{background:var(--clip4b)}
#vol-sl-4::-webkit-slider-thumb{background:var(--clip5b)}
#vol-sl-5::-webkit-slider-thumb{background:var(--clip6b)}

.pan-row{display:flex;align-items:center;gap:4px}
.pan-sl{-webkit-appearance:none;flex:1;height:3px;background:var(--border2);border-radius:2px;outline:none;cursor:pointer}
.pan-sl::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent4);border-radius:50%}

/* ‚îÄ‚îÄ TRACK LANE ‚îÄ‚îÄ */
.track-lane{flex:1;background:var(--bg2);position:relative;overflow:hidden;
  cursor:crosshair;min-height:0}
.track-lane:hover{background:var(--bg3)}
.lane-inner{position:absolute;top:0;left:0;height:100%;pointer-events:none}

/* ‚îÄ‚îÄ CLIPS ‚îÄ‚îÄ */
.clip{position:absolute;top:0px;bottom:0px;border-radius:3px;overflow:hidden;
  cursor:grab;user-select:none;display:flex;flex-direction:column;
  border:1px solid transparent;transition:border-color .1s, box-shadow .1s;pointer-events:all}
.clip:active{cursor:grabbing}
.clip.selected{border-color:#fff !important;box-shadow:0 0 0 1px rgba(255,255,255,0.3)}
.clip-hdr{font-size:9px;padding:2px 5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-family:'Syne',sans-serif;font-weight:600;flex-shrink:0;letter-spacing:.5px}
.clip-wave{display:block;flex:1;width:100%}
.clip-resize-r{position:absolute;right:0;top:0;bottom:0;width:6px;cursor:ew-resize;
  background:rgba(255,255,255,0.1);border-radius:0 3px 3px 0}
.clip-resize-r:hover{background:rgba(255,255,255,0.3)}

/* ‚îÄ‚îÄ PLAYHEAD ‚îÄ‚îÄ */
.playhead-line{position:absolute;top:0;bottom:0;width:2px;pointer-events:none;z-index:20;
  background:var(--accent2);box-shadow:0 0 6px var(--accent2)}
.playhead-head{position:absolute;top:0;left:-4px;width:10px;height:10px;
  background:var(--accent2);clip-path:polygon(50% 100%,0 0,100% 0)}

/* ‚îÄ‚îÄ MIXER SECTION ‚îÄ‚îÄ */
#mixer-section{height:var(--mixer-h);background:var(--bg2);border-top:2px solid var(--border2);
  display:flex;overflow-x:auto;flex-shrink:0;transition:height .25s ease}
#mixer-section.collapsed{height:0;overflow:hidden}
.mx-ch{display:flex;flex-direction:column;align-items:center;padding:8px 6px;
  gap:4px;min-width:64px;border-right:1px solid var(--border);flex-shrink:0}
.mx-ch-name{font-size:9px;color:var(--text3);text-align:center;width:56px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:'Syne';font-weight:600}
.mx-meter-wrap{display:flex;gap:2px;height:80px;align-items:flex-end}
.mx-meter{width:7px;height:80px;background:var(--bg);border-radius:2px;
  border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column-reverse}
.mx-meter-fill{width:100%;transition:height .06s;border-radius:2px}
.mx-fader-wrap{position:relative;height:80px;width:20px;display:flex;justify-content:center}
.mx-fader-track{width:4px;height:80px;background:var(--bg);border:1px solid var(--border2);
  border-radius:2px;position:relative;cursor:pointer}
.mx-fader-fill{position:absolute;bottom:0;left:0;right:0;border-radius:2px}
.mx-fader-thumb{position:absolute;left:50%;transform:translateX(-50%);
  width:20px;height:8px;background:var(--surface3);border:1px solid var(--border2);
  border-radius:2px;cursor:grab;z-index:2}
.mx-fader-thumb:active{cursor:grabbing}
.mx-send-lbl{font-size:8px;color:var(--text3);font-family:'DM Mono'}
.mx-master{border-left:2px solid var(--border2);padding-left:10px}
.mx-master-lbl{font-size:10px;font-family:'Bebas Neue';color:var(--accent);letter-spacing:1px}
.mx-eq-mini{display:flex;gap:2px;margin-top:2px}
.mx-eq-mini input{-webkit-appearance:none;width:14px;height:40px;
  background:var(--bg);border:1px solid var(--border);border-radius:2px;
  cursor:pointer;writing-mode:vertical-lr;direction:rtl;outline:none}
.mx-eq-mini input::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:5px;
  background:var(--accent3);border-radius:1px}

/* ‚îÄ‚îÄ BOTTOM TOOLBAR ‚îÄ‚îÄ */
#toolbar{height:var(--toolbar-h);background:var(--bg2);border-top:1px solid var(--border);
  display:flex;align-items:center;padding:0 10px;gap:8px;flex-shrink:0;overflow-x:auto}
.tg{display:flex;gap:4px;align-items:center;padding-right:8px;border-right:1px solid var(--border);flex-shrink:0}
.tg:last-child{border:none;margin-left:auto}
.tool-btn{background:var(--surface);border:1px solid var(--border2);color:var(--text2);
  padding:4px 9px;border-radius:60px;cursor:pointer;font-family:'DM Mono';font-size:10px;
  transition:all .1s;white-space:nowrap}
.tool-btn:hover{border-color:var(--accent);color:var(--accent)}
.tool-btn.on{background:rgba(232,255,0,0.08);border-color:var(--accent);color:var(--accent)}
.zoom-sl{-webkit-appearance:none;width:70px;height:3px;background:var(--border2);border-radius:2px;cursor:pointer;outline:none}
.zoom-sl::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent4);border-radius:50%}
.status{font-size:9px;color:var(--text3);letter-spacing:.5px;white-space:nowrap}

/* ‚îÄ‚îÄ LIBRARY PANEL ‚îÄ‚îÄ */
#lib-panel{position:fixed;right:0;top:0;bottom:0;width:260px;background:var(--surface);
  border-left:1px solid var(--border2);z-index:100;transform:translateX(100%);
  transition:transform .25s ease;display:flex;flex-direction:column}
#lib-panel.open{transform:translateX(0)}
#lib-header{padding:10px 12px;border-bottom:1px solid var(--border2);
  display:flex;align-items:center;justify-content:space-between}
#lib-header h3{font-family:'Bebas Neue';font-size:1.1rem;color:var(--accent);letter-spacing:2px}
#lib-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px}
#lib-search{margin:8px 10px;background:var(--bg2);border:1px solid var(--border2);
  color:var(--text);padding:6px 10px;border-radius:3px;font-family:'DM Mono';font-size:11px;width:calc(100%-20px)}
#lib-cats{display:flex;gap:4px;padding:0 10px 6px;flex-wrap:wrap}
.lib-cat{background:var(--bg2);border:1px solid var(--border);color:var(--text2);
  padding:2px 8px;border-radius:20px;cursor:pointer;font-size:9px;transition:all .1s}
.lib-cat.on{background:rgba(232,255,0,0.1);border-color:var(--accent);color:var(--accent)}
#lib-list{flex:1;overflow-y:auto;padding:6px 10px;display:flex;flex-direction:column;gap:4px}
.lib-item{background:var(--bg2);border:1px solid var(--border);border-radius:4px;
  padding:7px 9px;cursor:pointer;display:flex;align-items:center;gap:7px;
  transition:all .12s;user-select:none}
.lib-item:hover{border-color:var(--accent2);background:var(--surface2)}
.lib-item.dragging{opacity:.5}
.lib-icon{font-size:14px;flex-shrink:0}
.lib-info{flex:1;min-width:0}
.lib-name{font-size:11px;font-weight:500;font-family:'Syne';overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lib-meta{font-size:9px;color:var(--text2)}
.lib-play-btn{background:none;border:1px solid var(--border);color:var(--text3);
  width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:9px;flex-shrink:0}
.lib-play-btn:hover{border-color:var(--accent3);color:var(--accent3)}
.lib-drop-zone{border:2px dashed var(--border);border-radius:6px;padding:14px;
  text-align:center;color:var(--text3);cursor:pointer;margin:8px 10px;font-size:10px;transition:all .2s}
.lib-drop-zone:hover,.lib-drop-zone.over{border-color:var(--accent);color:var(--accent);background:rgba(232,255,0,0.03)}

/* ‚îÄ‚îÄ CLIP EDITOR PANEL ‚îÄ‚îÄ */
#clip-editor{position:fixed;bottom:0;left:0;right:0;height:220px;background:var(--surface);
  border-top:2px solid var(--accent2);z-index:90;transform:translateY(100%);
  transition:transform .25s ease;display:flex;flex-direction:column}
#clip-editor.open{transform:translateY(0)}
#ce-header{display:flex;align-items:center;gap:8px;padding:6px 12px;border-bottom:1px solid var(--border2)}
#ce-title{font-family:'Bebas Neue';font-size:1rem;color:var(--accent2);letter-spacing:2px;flex:1}
#ce-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px}
#ce-body{display:flex;flex:1;overflow:hidden}
#ce-wave-wrap{flex:1;position:relative;overflow:hidden;cursor:crosshair;background:var(--bg2)}
#ce-canvas{display:block;width:100%;height:100%}
.ce-region{position:absolute;top:0;bottom:0;background:rgba(232,255,0,0.08);border-left:2px solid var(--accent);border-right:2px solid var(--accent)}
.ce-handle{position:absolute;top:0;bottom:0;width:8px;cursor:ew-resize;z-index:5}
.ce-handle-l{left:0;background:rgba(232,255,0,0.3)}
.ce-handle-r{right:0;background:rgba(232,255,0,0.3)}
#ce-controls{width:200px;padding:10px;border-left:1px solid var(--border2);display:flex;flex-direction:column;gap:7px;flex-shrink:0;overflow-y:auto}
.ce-row{display:flex;flex-direction:column;gap:2px}
.ce-lbl{font-size:9px;color:var(--text3);letter-spacing:.5px}
.ce-sl{-webkit-appearance:none;width:100%;height:3px;background:var(--border2);border-radius:2px;cursor:pointer;outline:none}
.ce-sl::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent2);border-radius:50%}
.ce-btn-row{display:flex;gap:4px}
.ce-btn{flex:1;background:var(--bg2);border:1px solid var(--border2);color:var(--text2);
  padding:4px 6px;border-radius:3px;cursor:pointer;font-size:9px;font-family:'DM Mono';
  text-align:center;transition:all .1s}
.ce-btn:hover{border-color:var(--accent);color:var(--accent)}
.ce-btn.primary{border-color:var(--accent2);color:var(--accent2)}
.ce-btn.primary:hover{background:rgba(255,45,107,0.1)}

/* ‚îÄ‚îÄ EXPORT MODAL ‚îÄ‚îÄ */
#export-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);
  z-index:200;align-items:center;justify-content:center}
#export-modal.show{display:flex}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:6px;
  padding:24px;width:360px;max-width:95vw;box-shadow:0 0 60px rgba(0,212,255,0.1)}
.modal-title{font-family:'Bebas Neue';font-size:1.3rem;color:var(--accent3);letter-spacing:2px;margin-bottom:14px}
.modal-row{margin-bottom:10px}
.modal-lbl{font-size:10px;color:var(--text2);margin-bottom:4px;display:block}
.modal-input{width:100%;background:var(--bg);border:1px solid var(--border2);
  color:var(--text);padding:7px 10px;border-radius:3px;font-family:'DM Mono';font-size:11px}
.modal-input:focus{outline:none;border-color:var(--accent3)}
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.fmt-opt{background:var(--bg2);border:1px solid var(--border);color:var(--text2);
  padding:9px 10px;border-radius:4px;cursor:pointer;text-align:center;
  font-size:12px;font-family:'DM Mono';transition:all .12s}
.fmt-opt.on{background:rgba(0,212,255,0.1);border-color:var(--accent3);color:var(--accent3)}
.exp-progress{width:100%;height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-bottom:8px;display:none}
.exp-prog-fill{height:100%;background:linear-gradient(90deg,var(--accent4),var(--accent3));border-radius:3px;transition:width .2s}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.modal-btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text);
  padding:7px 16px;border-radius:3px;cursor:pointer;font-family:'DM Mono';font-size:11px;transition:all .12s}
.modal-btn:hover{border-color:var(--accent3);color:var(--accent3)}
.modal-btn.primary{background:rgba(0,212,255,0.1);border-color:var(--accent3);color:var(--accent3)}

/* ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ */
#ctx-menu{display:none;position:fixed;background:var(--surface);border:1px solid var(--border2);
  border-radius:4px;z-index:300;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
#ctx-menu.show{display:block}
.ctx-item{padding:7px 14px;cursor:pointer;font-size:11px;display:flex;align-items:center;gap:7px;transition:background .08s}
.ctx-item:hover{background:var(--surface2);color:var(--accent)}
.ctx-sep{height:1px;background:var(--border);margin:2px 0}

/* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
#notif{position:fixed;bottom:50px;right:16px;z-index:400;background:var(--surface);
  border:1px solid var(--border2);color:var(--text);padding:8px 14px;border-radius:4px;
  font-size:11px;font-family:'DM Mono';box-shadow:0 4px 20px rgba(0,0,0,0.4);
  transform:translateY(50px);opacity:0;transition:all .25s;max-width:250px;pointer-events:none}
#notif.show{transform:translateY(0);opacity:1}
#notif.success{border-color:var(--green);color:var(--green)}
#notif.error{border-color:var(--red);color:var(--red)}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media(max-width:680px){
  :root{--track-header-w:130px;--mixer-h:160px}
  .bpm-num{font-size:1rem;min-width:36px}
  #bpmSlider{width:40px}
  .logo{font-size:1.2rem}
  #lib-panel{width:100%}
  #clip-editor{height:180px}
  #ce-controls{width:150px}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="header">
  <div class="logo">STERL<em>ING</em> <span style="font-size:.8rem;color:var(--text2);font-family:'DM Mono'">MIX</span></div>

  <div class="transport">
    <button class="tbtn" id="btn-rewind" title="Inicio">‚èÆ</button>
    <button class="tbtn" id="btn-play">‚ñ∂ PLAY</button>
    <button class="tbtn" id="btn-stop" title="Stop">‚èπ</button>
    <button class="tbtn" id="btn-rec" title="Grabar">‚è∫</button>
    <button class="tbtn on" id="btn-loop" title="Loop">‚Üª</button>
  </div>

  <div class="bpm-box">
    <button onclick="changeBpm(-1)">‚àí</button>
    <label>BPM</label>
    <span class="bpm-num" id="bpm-display">120</span>
    <button onclick="changeBpm(1)">+</button>
    <input type="range" id="bpmSlider" min="40" max="300" value="120">
  </div>

  <div class="time-box" id="time-display">0:00.00</div>

  <div class="sig-box">
    <label>SIG</label>
    <select id="sig-select" onchange="timeSignature=parseInt(this.value);drawRuler()">
      <option value="4">4/4</option>
      <option value="3">3/4</option>
      <option value="6">6/8</option>
      <option value="2">2/4</option>
    </select>
  </div>

  <div class="header-spacer"></div>

  <button class="tbtn" id="btn-add-track" style="border-color:var(--accent4);color:var(--accent4)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"
     stroke="currentColor" stroke-width="1.6"
     stroke-linecap="round" stroke-linejoin="round">
  <path d="M9 18V5l10-2v13"/>
  <circle cx="7" cy="18" r="2"/>
  <circle cx="17" cy="16" r="2"/>
</svg> PISTA</button>
  <button class="tbtn" id="btn-library" style="border-color:var(--accent2);color:var(--accent2)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"
     stroke="currentColor" stroke-width="1.6"
     stroke-linecap="round" stroke-linejoin="round">
  <path d="M3 6h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
</svg> LIBRER√çA</button>
  <button class="tbtn export-btn" id="btn-export"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"
     stroke="currentColor" stroke-width="1.6"
     stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 16V4"/>
  <path d="M8 8l4-4 4 4"/>
  <path d="M4 20h16"/>
</svg> EXPORTAR</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FX BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="fxbar">
  <div class="fx-group">
    <div class="fx-lbl">REVERB</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="reverb-wet" data-val="50" data-min="0" data-max="100" title="Wet"></div>
        <div class="fx-knob-lbl">WET</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="reverb-decay" data-val="50" data-min="0" data-max="100" title="Decay"></div>
        <div class="fx-knob-lbl">DECAY</div>
      </div>
      <button class="fx-toggle" id="toggle-reverb">ON</button>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">DELAY</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="delay-time" data-val="50" data-min="0" data-max="100" title="Time"></div>
        <div class="fx-knob-lbl">TIME</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="delay-feedback" data-val="50" data-min="0" data-max="100" title="Feedback"></div>
        <div class="fx-knob-lbl">FB</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="delay-mix" data-val="50" data-min="0" data-max="100" title="Mix"></div>
        <div class="fx-knob-lbl">MIX</div>
      </div>
      <button class="fx-toggle" id="toggle-delay">ON</button>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">EQ MASTER</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="eq-lo" data-val="50" data-min="0" data-max="100" title="Low"></div>
        <div class="fx-knob-lbl">LO</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="eq-mid" data-val="50" data-min="0" data-max="100" title="Mid"></div>
        <div class="fx-knob-lbl">MID</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="eq-hi" data-val="50" data-min="0" data-max="100" title="Hi"></div>
        <div class="fx-knob-lbl">HI</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="eq-presence" data-val="50" data-min="0" data-max="100" title="Presence"></div>
        <div class="fx-knob-lbl">PRES</div>
      </div>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">COMPRESOR</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="comp-threshold" data-val="50" data-min="0" data-max="100" title="Threshold"></div>
        <div class="fx-knob-lbl">THRS</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="comp-ratio" data-val="50" data-min="0" data-max="100" title="Ratio"></div>
        <div class="fx-knob-lbl">RATIO</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="comp-makeup" data-val="50" data-min="0" data-max="100" title="Makeup Gain"></div>
        <div class="fx-knob-lbl">MAKE</div>
      </div>
      <button class="fx-toggle" id="toggle-comp">ON</button>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">DISTORCI√ìN</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="dist-amount" data-val="50" data-min="0" data-max="100" title="Amount"></div>
        <div class="fx-knob-lbl">DRIVE</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="dist-mix" data-val="50" data-min="0" data-max="100" title="Mix"></div>
        <div class="fx-knob-lbl">MIX</div>
      </div>
      <button class="fx-toggle" id="toggle-dist">OFF</button>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">FILTRO</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="filter-freq" data-val="50" data-min="0" data-max="100" title="Cutoff"></div>
        <div class="fx-knob-lbl">CUT</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="filter-res" data-val="50" data-min="0" data-max="100" title="Resonance"></div>
        <div class="fx-knob-lbl">RES</div>
      </div>
      <select id="filter-type" style="background:var(--bg2);border:1px solid var(--border);color:var(--text);font-size:9px;padding:2px;border-radius:3px">
        <option value="lowpass">LP</option>
        <option value="highpass">HP</option>
        <option value="bandpass">BP</option>
        <option value="notch">NTH</option>
      </select>
    </div>
  </div>
  <div class="fx-sep"></div>

  <div class="fx-group">
    <div class="fx-lbl">MAIN</div>
    <div class="fx-row">
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="master-vol" data-val="50" data-min="0" data-max="100" title="Volume"></div>
        <div class="fx-knob-lbl">VOL</div>
      </div>
      <div class="fx-knob-wrap">
        <div class="fx-knob" data-fx="master-limiter" data-val="50" data-min="0" data-max="100" title="Limiter"></div>
        <div class="fx-knob-lbl">LIM</div>
      </div>
    </div>
  </div>

  <button id="fxbar-toggle" title="Ocultar FX"><i class="fi fi-sr-arrow-up-from-dotted-line"></i></button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main">
  <div id="timeline-area">
    <!-- Ruler -->
    <div id="ruler-row">
      <div id="ruler-corner">
        <div id="ruler-corner-inner">
          <button class="tbtn" id="btn-mixer-toggle" style="font-size:9px;padding:2px 6px"><i class="fi fi-sr-speakers"></i> MIX</button>
          <button class="tbtn" id="btn-fx-toggle" style="font-size:9px;padding:2px 6px"><i class="fi fi-sr-dial-med"></i> FX</button>
        </div>
      </div>
      <div id="ruler-scroll">
        <canvas id="ruler-canvas" height="24"></canvas>
      </div>
    </div>

    <!-- Tracks -->
    <div id="tracks-outer">
      <div id="tracks-scroll" id="tracks-container">
        <!-- tracks injected here -->
        <div id="drop-zone-hint" style="padding:20px;text-align:center;color:var(--text3);font-size:11px;display:none">
          ‚Üë A√±ade pistas para comenzar. Arrastra archivos de audio aqu√≠ o usa + PISTA
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MIXER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="mixer-section">
    <div id="mixer-inner" style="display:flex;padding:6px 0;align-items:flex-start">
      <!-- channels injected -->
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM TOOLBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="toolbar">
  <div class="tg">
    <button class="tool-btn on" id="tool-select" title="Seleccionar"><i class="fi fi-sr-mouse-pointer-click"></i> SELECCIONAR</button>
    <button class="tool-btn" id="tool-pencil" title="Dibujar"><i class="fi fi-sr-white-space"></i> PISTA EN BLANCO</button>
    <button class="tool-btn" id="tool-cut" title="Cortar"><i class="fi fi-sr-scalpel-path"></i> CORTAR</button>
    <button class="tool-btn" id="tool-erase" title="Borrar"><i class="fi fi-sr-delete"></i> BORRAR</button>
  </div>
  <div class="tg">
    <button class="tool-btn on" id="btn-snap"><i class="fi fi-sr-table-list"></i> AJUSTAR A CUADRICULA</button>
    <label class="tool-btn" style="cursor:pointer" title="Cargar audio"><i class="fi fi-sr-add-folder"></i> CARGAR
      <input type="file" id="file-input" accept="audio/*" multiple style="display:none">
    </label>
  </div>
  <div class="tg">
    <span style="font-size:9px;color:var(--text3)">ZOOM</span>
    <input type="range" class="zoom-sl" id="zoom-sl" min="0.3" max="5" step="0.05" value="1">
    <span id="zoom-val" style="font-size:9px;color:var(--accent4);min-width:28px">1.0√ó</span>
  </div>
  <div class="tg">
    <span class="status" id="status-bar">SANTIAGO STERLING</span>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIBRARY PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lib-panel">
  <div id="lib-header">
    <h3>LIBRER√çA</h3>
    <button id="lib-close">‚úï</button>
  </div>
  <input type="text" id="lib-search" placeholder="Buscar samples...">
  <div id="lib-cats">
    <button class="lib-cat on" data-cat="all">TODO</button>
    <button class="lib-cat" data-cat="drums">DRUMS</button>
    <button class="lib-cat" data-cat="bass">BASS</button>
    <button class="lib-cat" data-cat="synth">SYNTH</button>
    <button class="lib-cat" data-cat="fx">FX</button>
    <button class="lib-cat" data-cat="perc">PERC</button>
  </div>
  <div id="lib-list"></div>
  <div class="lib-drop-zone" id="lib-drop-zone">
    <div style="font-size:20px;margin-bottom:4px">üìÇ</div>
    Arrastra archivos de audio aqu√≠<br>para a√±adirlos a la librer√≠a
    <input type="file" id="lib-file-input" accept="audio/*" multiple style="display:none">
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLIP EDITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="clip-editor">
  <div id="ce-header">
    <span id="ce-title">EDITOR DE CLIP</span>
    <div style="display:flex;gap:6px;align-items:center">
      <span id="ce-clip-name" style="font-size:10px;color:var(--text2)"></span>
    </div>
    <button id="ce-close">‚úï</button>
  </div>
  <div id="ce-body">
    <div id="ce-wave-wrap">
      <canvas id="ce-canvas"></canvas>
      <div id="ce-region">
        <div class="ce-handle ce-handle-l" id="ce-handle-l"></div>
        <div class="ce-handle ce-handle-r" id="ce-handle-r"></div>
      </div>
    </div>
    <div id="ce-controls">
      <div class="ce-row">
        <div class="ce-lbl">GAIN</div>
        <input type="range" class="ce-sl" id="ce-gain" min="0" max="200" value="100">
        <span id="ce-gain-val" style="font-size:9px;color:var(--text2)">100%</span>
      </div>
      <div class="ce-row">
        <div class="ce-lbl">PITCH (semitones)</div>
        <input type="range" class="ce-sl" id="ce-pitch" min="-12" max="12" value="0" step="1">
        <span id="ce-pitch-val" style="font-size:9px;color:var(--text2)">0</span>
      </div>
      <div class="ce-row">
        <div class="ce-lbl">FADE IN</div>
        <input type="range" class="ce-sl" id="ce-fadein" min="0" max="100" value="0">
      </div>
      <div class="ce-row">
        <div class="ce-lbl">FADE OUT</div>
        <input type="range" class="ce-sl" id="ce-fadeout" min="0" max="100" value="0">
      </div>
      <div class="ce-row">
        <div class="ce-lbl">REVERSA</div>
        <input type="checkbox" id="ce-reverse" style="accent-color:var(--accent2)">
        <label for="ce-reverse" style="font-size:9px;color:var(--text2)"> Invertir clip</label>
      </div>
      <div class="ce-row">
        <div class="ce-lbl">TRIM START: <span id="trim-s-val">0.00s</span></div>
        <div class="ce-lbl">TRIM END: <span id="trim-e-val">0.00s</span></div>
      </div>
      <div class="ce-btn-row">
        <button class="ce-btn primary" id="ce-apply">‚úì APLICAR</button>
        <button class="ce-btn" id="ce-split">‚úÇ DIVIDIR</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="export-modal">
  <div class="modal-box">
    <div class="modal-title">EXPORTAR MEZCLA</div>
    <div class="modal-row">
      <span class="modal-lbl">Nombre del archivo</span>
      <input type="text" class="modal-input" id="exp-name" value="mi_mezcla">
    </div>
    <div class="modal-row">
      <span class="modal-lbl">Formato</span>
      <div class="fmt-grid" id="fmt-grid">
        <div class="fmt-opt on" data-fmt="wav">WAV<br><small style="font-size:9px;color:var(--text2)">Sin p√©rdida</small></div>
        <div class="fmt-opt" data-fmt="webm-mp3">MP3/WEBM<br><small style="font-size:9px;color:var(--text2)">Comprimido</small></div>
        <div class="fmt-opt" data-fmt="ogg">OGG<br><small style="font-size:9px;color:var(--text2)">Open source</small></div>
        <div class="fmt-opt" data-fmt="flac-wav">FLAC/WAV<br><small style="font-size:9px;color:var(--text2)">Alta calidad</small></div>
      </div>
    </div>
    <div class="modal-row">
      <span class="modal-lbl">Sample rate</span>
      <select class="modal-input" id="exp-sr">
        <option value="48000">48000 Hz (Pro)</option>
        <option value="44100" selected>44100 Hz (CD)</option>
        <option value="22050">22050 Hz (Web)</option>
      </select>
    </div>
    <div class="modal-row">
      <span class="modal-lbl">Rango a exportar</span>
      <select class="modal-input" id="exp-range">
        <option value="all">Todo el proyecto</option>
        <option value="loop">Solo regi√≥n del loop</option>
        <option value="selection">Solo selecci√≥n</option>
      </select>
    </div>
    <div class="exp-progress" id="exp-progress">
      <div class="exp-prog-fill" id="exp-prog-fill" style="width:0%"></div>
    </div>
    <div id="exp-status" style="font-size:10px;color:var(--text2);min-height:16px;font-family:'DM Mono'"></div>
    <div class="modal-btns">
      <button class="modal-btn" id="btn-cancel-exp">Cancelar</button>
      <button class="modal-btn primary" id="btn-do-export">‚¨á EXPORTAR</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTEXT MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-edit">Editar clip</div>
  <div class="ctx-item" id="ctx-split">Dividir aqu√≠</div>
  <div class="ctx-item" id="ctx-duplicate">Duplicar</div>
  <div class="ctx-item" id="ctx-color">Cambiar color</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" id="ctx-mute-clip">Silenciar clip</div>
  <div class="ctx-item" id="ctx-reverse">Invertir</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" id="ctx-delete" style="color:var(--red)">Eliminar</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="notif"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';
// ‚îÄ‚îÄ‚îÄ AUDIO CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let AC = null;
function getAC(){
  if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)();
  if(AC.state==='suspended') AC.resume();
  return AC;
}

// ‚îÄ‚îÄ‚îÄ AUDIO GRAPH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let masterGain, masterAnalyser, limiterNode;
let reverbGain, reverbDry, reverbConvolver, reverbWetGain;
let delayNode, delayFeedbackGain, delayWetGain, delayDryGain;
let eqLo, eqLomid, eqHimid, eqHi, eqPresence;
let compressor;
let distortion, distDryGain, distWetGain;
let filterNode;
let fxEnabled = {reverb:true, delay:true, comp:true, dist:false};

function buildAudioGraph(){
  const ctx = getAC();
  // Master
  masterGain = ctx.createGain(); masterGain.gain.value = 0.8;
  masterAnalyser = ctx.createAnalyser(); masterAnalyser.fftSize = 2048;
  limiterNode = ctx.createDynamicsCompressor();
  limiterNode.threshold.value = -1; limiterNode.knee.value = 0;
  limiterNode.ratio.value = 20; limiterNode.attack.value = 0.001; limiterNode.release.value = 0.01;

  // EQ (4-band)
  eqLo = ctx.createBiquadFilter(); eqLo.type = 'lowshelf'; eqLo.frequency.value = 80;
  eqLomid = ctx.createBiquadFilter(); eqLomid.type = 'peaking'; eqLomid.frequency.value = 500; eqLomid.Q.value = 1;
  eqHimid = ctx.createBiquadFilter(); eqHimid.type = 'peaking'; eqHimid.frequency.value = 3000; eqHimid.Q.value = 1;
  eqHi = ctx.createBiquadFilter(); eqHi.type = 'highshelf'; eqHi.frequency.value = 10000;
  eqPresence = ctx.createBiquadFilter(); eqPresence.type = 'peaking'; eqPresence.frequency.value = 5000; eqPresence.Q.value = 2;

  // Compressor
  compressor = ctx.createDynamicsCompressor();
  compressor.threshold.value = -24; compressor.knee.value = 30;
  compressor.ratio.value = 4; compressor.attack.value = 0.003; compressor.release.value = 0.25;

  // Reverb
  reverbConvolver = ctx.createConvolver();
  buildImpulse(2.5);
  reverbWetGain = ctx.createGain(); reverbWetGain.gain.value = 0.2;
  reverbDry = ctx.createGain(); reverbDry.gain.value = 1;
  reverbGain = ctx.createGain(); reverbGain.gain.value = 1;

  // Delay
  delayNode = ctx.createDelay(4);
  delayNode.delayTime.value = 0.375;
  delayFeedbackGain = ctx.createGain(); delayFeedbackGain.gain.value = 0.25;
  delayWetGain = ctx.createGain(); delayWetGain.gain.value = 0.3;
  delayDryGain = ctx.createGain(); delayDryGain.gain.value = 1;

  // Distortion
  distortion = ctx.createWaveShaper();
  buildDistCurve(200);
  distWetGain = ctx.createGain(); distWetGain.gain.value = 0;
  distDryGain = ctx.createGain(); distDryGain.gain.value = 1;

  // Filter
  filterNode = ctx.createBiquadFilter();
  filterNode.type = 'lowpass'; filterNode.frequency.value = 20000; filterNode.Q.value = 1;

  // Chain: masterGain ‚Üí EQ ‚Üí comp ‚Üí dist ‚Üí filter ‚Üí reverb ‚Üí delay ‚Üí limiter ‚Üí analyser ‚Üí dest
  masterGain.connect(eqLo);
  eqLo.connect(eqLomid); eqLomid.connect(eqHimid); eqHimid.connect(eqHi); eqHi.connect(eqPresence);
  eqPresence.connect(compressor);
  // Distortion parallel
  compressor.connect(distDryGain);
  compressor.connect(distortion); distortion.connect(distWetGain);
  distDryGain.connect(filterNode); distWetGain.connect(filterNode);
  // Filter ‚Üí reverb
  filterNode.connect(reverbDry);
  filterNode.connect(reverbConvolver); reverbConvolver.connect(reverbWetGain);
  reverbDry.connect(delayDryGain); reverbWetGain.connect(delayDryGain);
  // Delay
  delayDryGain.connect(delayWetGain); // initially delay is parallel with dry
  filterNode.connect(delayNode); delayNode.connect(delayFeedbackGain);
  delayFeedbackGain.connect(delayNode); delayNode.connect(delayWetGain);
  delayDryGain.connect(limiterNode); delayWetGain.connect(limiterNode);
  // Out
  limiterNode.connect(masterAnalyser); masterAnalyser.connect(ctx.destination);
}

function buildImpulse(decay){
  const ctx = getAC();
  const sr = ctx.sampleRate, len = Math.round(sr * decay);
  const buf = ctx.createBuffer(2, len, sr);
  for(let c=0;c<2;c++){
    const d = buf.getChannelData(c);
    for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * Math.pow(1 - i/len, 2);
  }
  if(reverbConvolver) reverbConvolver.buffer = buf;
}

function buildDistCurve(amount){
  const n = 256, curve = new Float32Array(n);
  const k = amount;
  for(let i=0;i<n;i++){
    const x = i*2/n - 1;
    curve[i] = (3+k) * x * 20 * Math.PI/180 / (Math.PI + k*Math.abs(x));
  }
  if(distortion) distortion.curve = curve;
}

function ensureGraph(){ if(!masterGain) buildAudioGraph(); }

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bpm = 120, timeSignature = 4, zoom = 1, snap = true;
let isPlaying = false, isLooping = true, isRecording = false;
let playhead = 0, playStartAC = 0, playStartOffset = 0;
let raf = null;
let activeTool = 'select';
let selectedClipId = null;
let contextClipId = null, contextTrackId = null, contextX = 0;
let exportFormat = 'wav';
let libFilter = 'all', libSearch = '';
let loopStart = 0, loopEnd = 32; // in seconds
let tracksData = []; // array of track objects
let libraryItems = []; // prebuilt + user-loaded
let clipEditorClip = null;
let trimStart = 0, trimEnd = 0;
const TRACK_COLORS = [
  {border:'#e8ff00',bg:'rgba(232,255,0,0.12)'},
  {border:'#ff2d6b',bg:'rgba(255,45,107,0.12)'},
  {border:'#00d4ff',bg:'rgba(0,212,255,0.12)'},
  {border:'#b400ff',bg:'rgba(180,0,255,0.12)'},
  {border:'#00ff88',bg:'rgba(0,255,136,0.12)'},
  {border:'#ff8800',bg:'rgba(255,136,0,0.12)'},
  {border:'#ff4488',bg:'rgba(255,68,136,0.12)'},
  {border:'#44ddff',bg:'rgba(68,221,255,0.12)'},
];
const PPB = () => (60/bpm) * 80 * zoom; // pixels per beat
const PPS = () => 80 * zoom; // pixels per second
const TRACK_NUM = () => tracksData.length;
let nextTrackId = 1, nextClipId = 1;

// ‚îÄ‚îÄ‚îÄ SYNTH SAMPLES (PCM generators) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genBuf(duration, fn){
  const ctx = getAC(); const sr = ctx.sampleRate;
  const len = Math.round(sr*duration);
  const buf = ctx.createBuffer(2, len, sr);
  for(let c=0;c<2;c++){
    const d = buf.getChannelData(c);
    for(let i=0;i<len;i++) d[i] = fn(i/sr, i, sr, c);
  }
  return buf;
}
function env(t,a,d,s,r,dur){ // ADSR
  if(t<a) return t/a;
  if(t<a+d) return 1-(1-s)*(t-a)/d;
  if(t<dur-r) return s;
  return s*(1-(t-(dur-r))/r);
}

const SAMPLES = {
  'Kick 808': ()=>genBuf(0.8,t=>{
    const e = Math.exp(-t*8);
    return Math.sin(2*Math.PI*(60-55*t)*t)*e*0.9 + (Math.random()*0.1-0.05)*Math.exp(-t*40)*0.3;
  }),
  'Kick Tight': ()=>genBuf(0.35,t=>Math.sin(2*Math.PI*(80-70*t*2)*t)*Math.exp(-t*18)*0.8),
  'Snare Crack': ()=>genBuf(0.3,t=>(Math.random()*2-1)*Math.exp(-t*20)*0.6 + Math.sin(2*Math.PI*250*t)*Math.exp(-t*30)*0.4),
  'Snare Rimshot': ()=>genBuf(0.15,t=>(Math.random()*2-1)*Math.exp(-t*40)*0.5 + Math.sin(2*Math.PI*600*t)*Math.exp(-t*50)*0.3),
  'Hi-Hat Closed': ()=>genBuf(0.06,(t,i,sr)=>(Math.random()*2-1)*Math.exp(-t*80)*0.5),
  'Hi-Hat Open': ()=>genBuf(0.35,t=>(Math.random()*2-1)*Math.exp(-t*8)*0.4),
  'Clap': ()=>genBuf(0.2,t=>{
    const bursts = [0,0.012,0.02].map(d=>t>d?(Math.random()*2-1)*Math.exp(-(t-d)*60):0);
    return bursts.reduce((a,b)=>a+b)*0.6;
  }),
  'Crash Cymbal': ()=>genBuf(1.8,t=>(Math.random()*2-1)*Math.exp(-t*3)*0.35),
  'Tom High': ()=>genBuf(0.25,t=>Math.sin(2*Math.PI*(220-120*t)*t)*Math.exp(-t*15)*0.7),
  'Tom Low': ()=>genBuf(0.4,t=>Math.sin(2*Math.PI*(100-60*t)*t)*Math.exp(-t*10)*0.7),
  'Bass Sub 808': ()=>genBuf(1.2,t=>Math.sin(2*Math.PI*50*t)*env(t,.005,.1,.8,.2,1.2)*0.9),
  'Bass Pluck': ()=>genBuf(0.5,t=>{
    const f=80; const h = [1,2,3,4].map((n,i)=>Math.sin(2*Math.PI*f*n*t)*[1,.5,.25,.1][i]);
    return h.reduce((a,b)=>a+b)*env(t,.002,.05,.3,.1,.5)*0.7;
  }),
  'Synth Lead': ()=>genBuf(0.8,t=>{
    const f=440; const s=Math.sin(2*Math.PI*f*t)+Math.sin(2*Math.PI*f*1.01*t)*0.5+Math.sin(2*Math.PI*f*2*t)*0.25;
    return s*env(t,.01,.1,.7,.2,.8)*0.3;
  }),
  'Synth Pad': ()=>genBuf(2,t=>{
    const f=220; const s=[1,5/4,3/2,7/4].map(r=>Math.sin(2*Math.PI*f*r*t)).reduce((a,b)=>a+b);
    return s*env(t,.4,.1,.8,.4,2)*0.2;
  }),
  'Synth Stab': ()=>genBuf(0.15,t=>{
    const f=440; const s=Math.sin(2*Math.PI*f*t)*0.6+Math.sin(2*Math.PI*f*2*t)*0.3+(Math.random()-.5)*0.1;
    return s*Math.exp(-t*20)*0.5;
  }),
  'Chord Major': ()=>genBuf(1.5,t=>{
    const r=[1,5/4,3/2];
    return r.map(n=>Math.sin(2*Math.PI*220*n*t)).reduce((a,b)=>a+b)*env(t,.1,.1,.7,.3,1.5)*0.2;
  }),
  'Chord Minor': ()=>genBuf(1.5,t=>{
    const r=[1,6/5,3/2];
    return r.map(n=>Math.sin(2*Math.PI*220*n*t)).reduce((a,b)=>a+b)*env(t,.1,.1,.7,.3,1.5)*0.2;
  }),
  'Perc Conga': ()=>genBuf(0.3,t=>Math.sin(2*Math.PI*(400-200*t)*t)*Math.exp(-t*20)*0.5+(Math.random()-.5)*Math.exp(-t*50)*0.2),
  'Perc Shaker': ()=>genBuf(0.12,t=>(Math.random()*2-1)*Math.exp(-t*30)*0.35),
  'FX Riser': ()=>genBuf(2,t=>{
    const f=50+50*t*t;
    return (Math.sin(2*Math.PI*f*t)+Math.sin(2*Math.PI*f*1.02*t))*(t/2)*0.3;
  }),
  'FX Down': ()=>genBuf(1.5,t=>{
    const f=400-380*t/1.5;
    return Math.sin(2*Math.PI*f*t)*((1.5-t)/1.5)*0.4;
  }),
  'FX Vinyl': ()=>genBuf(0.1,t=>(Math.random()*2-1)*0.08),
  'Noise White': ()=>genBuf(0.5,t=>(Math.random()*2-1)*env(t,.01,.01,.8,.05,.5)*0.3),
  'Arp 1': ()=>genBuf(1.0,t=>{
    const notes=[440,523,659,784]; const step=Math.floor(t*8)%4; const f=notes[step];
    const ph=t*8%1; return Math.sin(2*Math.PI*f*t)*env(ph,.01,.01,.7,.1,0.125)*0.4;
  }),
};

const SAMPLE_CATS = {
  'Kick 808':'drums','Kick Tight':'drums','Snare Crack':'drums','Snare Rimshot':'drums',
  'Hi-Hat Closed':'drums','Hi-Hat Open':'drums','Clap':'drums','Crash Cymbal':'drums',
  'Tom High':'drums','Tom Low':'drums',
  'Bass Sub 808':'bass','Bass Pluck':'bass',
  'Synth Lead':'synth','Synth Pad':'synth','Synth Stab':'synth','Chord Major':'synth','Chord Minor':'synth','Arp 1':'synth',
  'Perc Conga':'perc','Perc Shaker':'perc',
  'FX Riser':'fx','FX Down':'fx','FX Vinyl':'fx','Noise White':'fx',
};
const SAMPLE_ICONS = {drums:'<i class="fi fi-sr-drum"></i>',bass:'<i class="fi fi-sr-guitar-electric"></i>',synth:'<i class="fi fi-sr-piano-keyboard"></i>',fx:'<i class="fi fi-sr-turntable"></i>',perc:'<i class="fi fi-sr-drum-steelpan"></i>'};

// ‚îÄ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initLibrary(){
  libraryItems = Object.keys(SAMPLES).map(name=>({
    id: 'built-'+name, name, cat: SAMPLE_CATS[name]||'fx',
    icon: SAMPLE_ICONS[SAMPLE_CATS[name]]||'üéµ',
    duration: null, buffer: null, user: false,
    bpm: null
  }));
  renderLibrary();
}

function renderLibrary(){
  const list = document.getElementById('lib-list');
  const search = libSearch.toLowerCase();
  const filtered = libraryItems.filter(it=>{
    const matchCat = libFilter==='all' || it.cat===libFilter;
    const matchSearch = !search || it.name.toLowerCase().includes(search);
    return matchCat && matchSearch;
  });
  list.innerHTML = '';
  filtered.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'lib-item';
    el.draggable = true;
    el.dataset.id = item.id;
    el.innerHTML = `
      <span class="lib-icon">${item.icon}</span>
      <div class="lib-info">
        <div class="lib-name">${item.name}</div>
        <div class="lib-meta">${item.cat.toUpperCase()} ${item.bpm?'¬∑ '+item.bpm+' BPM':''}</div>
      </div>
      <button class="lib-play-btn" title="Preview">‚ñ∂</button>
    `;
    // Preview
    el.querySelector('.lib-play-btn').addEventListener('click', e=>{
      e.stopPropagation(); previewLibItem(item);
    });
    // Double-click: add to last track
    el.addEventListener('dblclick', ()=>addLibItemToTrack(item, tracksData[tracksData.length-1]||createTrack(), 0));
    // Drag
    el.addEventListener('dragstart', ev=>{
      ev.dataTransfer.setData('lib-item-id', item.id);
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', ()=>el.classList.remove('dragging'));
    list.appendChild(el);
  });
}

let previewSrc = null;
function previewLibItem(item){
  ensureGraph();
  if(previewSrc){ try{previewSrc.stop()}catch(e){} previewSrc=null; }
  const buf = getLibBuffer(item);
  const src = getAC().createBufferSource();
  src.buffer = buf; src.connect(masterGain); src.start();
  previewSrc = src;
}

function getLibBuffer(item){
  if(!item.buffer){
    if(SAMPLES[item.name]) item.buffer = SAMPLES[item.name]();
    else return null;
  }
  return item.buffer;
}

async function addLibItemToTrack(item, track, startTime){
  ensureGraph();
  let buf = getLibBuffer(item);
  if(!buf){ notify('Error cargando sample','error'); return; }
  addClip(track, buf, item.name, startTime, null);
  notify(`‚úì ${item.name} a√±adido a "${track.name}"`,'success');
}

// ‚îÄ‚îÄ‚îÄ TRACK MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createTrack(name, color){
  ensureGraph();
  const ctx = getAC();
  const idx = tracksData.length;
  const col = color || TRACK_COLORS[idx % TRACK_COLORS.length];

  const gainNode = ctx.createGain(); gainNode.gain.value = 1;
  const panNode = ctx.createStereoPanner ? ctx.createStereoPanner() : null;
  const analyser = ctx.createAnalyser(); analyser.fftSize = 64;
  const trackEqLo = ctx.createBiquadFilter(); trackEqLo.type='lowshelf'; trackEqLo.frequency.value=200;
  const trackEqHi = ctx.createBiquadFilter(); trackEqHi.type='highshelf'; trackEqHi.frequency.value=4000;

  // Chain: gainNode ‚Üí EQ ‚Üí pan ‚Üí masterGain & analyser
  gainNode.connect(trackEqLo); trackEqLo.connect(trackEqHi);
  if(panNode){ trackEqHi.connect(panNode); panNode.connect(masterGain); panNode.connect(analyser); }
  else { trackEqHi.connect(masterGain); trackEqHi.connect(analyser); }
  analyser.connect(ctx.createGain()); // sink

  const track = {
    id: nextTrackId++,
    name: name || `Pista ${nextTrackId-1}`,
    color: col,
    volume: 1,
    pan: 0,
    muted: false,
    soloed: false,
    clips: [],
    gainNode, panNode, analyser,
    trackEqLo, trackEqHi,
    activeSources: [],
  };
  tracksData.push(track);
  renderTrackDOM(track);
  renderMixer();
  document.getElementById('drop-zone-hint').style.display='none';
  return track;
}

function deleteTrack(id){
  const idx = tracksData.findIndex(t=>t.id===id);
  if(idx===-1) return;
  const track = tracksData[idx];
  stopTrackSources(track);
  try{ track.gainNode.disconnect(); }catch(e){}
  tracksData.splice(idx,1);
  document.getElementById(`tr-${id}`)?.remove();
  renderMixer();
  if(!tracksData.length) document.getElementById('drop-zone-hint').style.display='block';
  notify('Pista eliminada');
}

function stopTrackSources(track){
  track.activeSources.forEach(s=>{ try{s.stop()}catch(e){} });
  track.activeSources=[];
}

function renderTrackDOM(track){
  const container = document.getElementById('tracks-scroll');
  const hint = document.getElementById('drop-zone-hint');
  const row = document.createElement('div');
  row.className = 'track-row';
  row.id = `tr-${track.id}`;
  row.dataset.trackId = track.id;

  const colorStr = track.color.border;
  const idx = tracksData.indexOf(track);

  row.innerHTML=`
    <div class="track-head">
      <div class="th-top">
        <div class="th-color" style="background:${colorStr}"></div>
        <span class="th-name" contenteditable="true" spellcheck="false" id="tname-${track.id}">${track.name}</span>
        <div class="th-btns">
          <button class="th-btn" id="tmute-${track.id}" title="Mute">M</button>
          <button class="th-btn" id="tsolo-${track.id}" title="Solo">S</button>
          <button class="th-btn del" title="Eliminar">‚úï</button>
        </div>
      </div>
      <div class="vol-row">
        <span class="vol-lbl" style="color:${colorStr}">VOL</span>
        <input type="range" class="vol-sl" id="vol-sl-${track.id}" min="0" max="150" value="100" step="1"
          style="--thumb-color:${colorStr}">
        <span class="vol-val" id="vol-val-${track.id}" style="color:${colorStr}">100%</span>
      </div>
      <div class="pan-row">
        <span class="vol-lbl" style="color:var(--text3)">PAN</span>
        <input type="range" class="pan-sl" id="pan-sl-${track.id}" min="-100" max="100" value="0" step="1">
        <span class="vol-val" id="pan-val-${track.id}" style="color:var(--text3)">C</span>
      </div>
    </div>
    <div class="track-lane" id="lane-${track.id}" data-track-id="${track.id}">
      <div class="lane-inner" id="lane-inner-${track.id}" style="min-width:${4000*zoom}px"></div>
      <div class="playhead-line" id="ph-${track.id}" style="left:-2px">
        <div class="playhead-head"></div>
      </div>
    </div>
  `;
  container.insertBefore(row, hint);

  // Events
  document.getElementById(`tname-${track.id}`).addEventListener('blur', e=>{
    track.name = e.target.textContent.trim()||track.name;
    refreshMixerName(track);
  });
  document.getElementById(`tmute-${track.id}`).addEventListener('click', ()=>toggleMute(track));
  document.getElementById(`tsolo-${track.id}`).addEventListener('click', ()=>toggleSolo(track));
  row.querySelector('.del').addEventListener('click', ()=>deleteTrack(track.id));

  const volSl = document.getElementById(`vol-sl-${track.id}`);
  volSl.style.setProperty('--c', colorStr);
  volSl.addEventListener('input', e=>{
    track.volume = e.target.value/100;
    document.getElementById(`vol-val-${track.id}`).textContent = e.target.value+'%';
    if(!track.muted) track.gainNode.gain.value = track.volume;
    updateMixerFader(track);
  });

  const panSl = document.getElementById(`pan-sl-${track.id}`);
  panSl.addEventListener('input', e=>{
    track.pan = e.target.value/100;
    if(track.panNode) track.panNode.pan.value = track.pan;
    const v = parseInt(e.target.value);
    document.getElementById(`pan-val-${track.id}`).textContent = v===0?'C':v>0?`R${v}`:`L${-v}`;
  });

  // Lane drop
  const lane = document.getElementById(`lane-${track.id}`);
  lane.addEventListener('dragover', e=>{ e.preventDefault(); row.classList.add('dragging-over'); });
  lane.addEventListener('dragleave', ()=>row.classList.remove('dragging-over'));
  lane.addEventListener('drop', e=>{
    e.preventDefault(); row.classList.remove('dragging-over');
    const libId = e.dataTransfer.getData('lib-item-id');
    if(libId){
      const item = libraryItems.find(i=>i.id===libId);
      if(item){
        const rect = lane.getBoundingClientRect();
        const x = e.clientX - rect.left + lane.scrollLeft;
        const startT = snapTime(x/PPS());
        addLibItemToTrack(item, track, startT);
      }
    } else if(e.dataTransfer.files.length){
      const rect = lane.getBoundingClientRect();
      const x = e.clientX - rect.left;
      loadFilesToTrack(track, e.dataTransfer.files, snapTime(x/PPS()));
    }
  });
  lane.addEventListener('click', e=>{
    if(e.target.classList.contains('clip')||e.target.closest('.clip')) return;
    const rect = lane.getBoundingClientRect();
    const x = e.clientX - rect.left;
    if(activeTool==='pencil'){
      // Add empty clip at this position (4 beats long)
      const startT = snapTime(x/PPS());
      const dur = (60/bpm)*4;
      addClip(track, generateSilence(dur), 'New Clip', startT);
    } else {
      playhead = Math.max(0, x/PPS());
      updatePlayheadDisplay();
    }
  });
}

function snapTime(t){
  if(!snap) return Math.max(0,t);
  const beat = 60/bpm;
  return Math.max(0, Math.round(t/beat)*beat);
}

function generateSilence(dur){
  const ctx=getAC();
  const buf=ctx.createBuffer(2,Math.round(ctx.sampleRate*dur),ctx.sampleRate);
  return buf;
}

// ‚îÄ‚îÄ‚îÄ CLIP MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addClip(track, buffer, name, startTime, color){
  const col = color || track.color;
  const clip = {
    id: nextClipId++,
    trackId: track.id,
    name: name||'Clip',
    buffer,
    originalBuffer: buffer,
    startTime: startTime||0,
    duration: buffer.duration,
    trimStart: 0, trimEnd: 0,
    gain: 1, pitch: 0,
    fadeIn: 0, fadeOut: 0,
    reversed: false,
    muted: false,
    color: col,
  };
  track.clips.push(clip);
  renderClipDOM(track, clip);
  return clip;
}

function renderClipDOM(track, clip){
  const laneInner = document.getElementById(`lane-inner-${track.id}`);
  if(!laneInner) return;
  document.getElementById(`clip-${clip.id}`)?.remove();

  const dur = clip.duration - clip.trimStart - clip.trimEnd;
  const el = document.createElement('div');
  el.className = 'clip';
  el.id = `clip-${clip.id}`;
  el.dataset.clipId = clip.id;
  el.dataset.trackId = track.id;
  el.style.left = Math.round(clip.startTime * PPS()) + 'px';
  el.style.width = Math.max(20, Math.round(dur * PPS())) + 'px';
  el.style.background = clip.color.bg;
  el.style.borderColor = clip.muted ? 'var(--border2)' : clip.color.border;
  el.style.opacity = clip.muted ? '0.4' : '1';

  const canvas = document.createElement('canvas');
  canvas.className = 'clip-wave';
  canvas.height = 44;

  el.innerHTML = `<div class="clip-hdr" style="color:${clip.color.border};background:${clip.color.border}18">${clip.name}</div>`;
  el.appendChild(canvas);
  el.innerHTML += `<div class="clip-resize-r" data-clip="${clip.id}"></div>`;
  el.appendChild(canvas);

  // Rebuild properly
  el.innerHTML='';
  const hdr = document.createElement('div');
  hdr.className='clip-hdr';
  hdr.style.color = clip.color.border;
  hdr.style.background = clip.color.border+'18';
  hdr.textContent = clip.name;
  el.appendChild(hdr);
  const wv = document.createElement('canvas');
  wv.className='clip-wave'; wv.height=44;
  el.appendChild(wv);
  const rzr = document.createElement('div');
  rzr.className='clip-resize-r'; rzr.dataset.clip=clip.id;
  el.appendChild(rzr);

  laneInner.appendChild(el);
  drawWaveform(wv, clip.buffer, clip.color.border, clip.trimStart, clip.duration-clip.trimEnd);

  // Resize
  initClipResize(rzr, clip, track);
  // Drag
  initClipDrag(el, clip, track);
  // Context menu
  el.addEventListener('contextmenu', e=>{
    e.preventDefault(); e.stopPropagation();
    contextClipId = clip.id; contextTrackId = track.id;
    contextX = e.clientX;
    showContextMenu(e.clientX, e.clientY);
  });
  // Double-click: open editor
  el.addEventListener('dblclick', e=>{ e.stopPropagation(); openClipEditor(clip, track); });
  // Click: select
  el.addEventListener('click', e=>{
    e.stopPropagation();
    if(activeTool==='erase'){ removeClip(track, clip.id); return; }
    if(activeTool==='cut'){
      const rect = el.getBoundingClientRect();
      const xInClip = e.clientX - rect.left;
      splitClipAt(track, clip, clip.startTime + xInClip/PPS());
      return;
    }
    selectClip(clip.id);
  });
}

function drawWaveform(canvas, buffer, color, trimS, trimE){
  const data0 = buffer.getChannelData(0);
  const data1 = buffer.numberOfChannels > 1 ? buffer.getChannelData(1) : data0;
  const sr = buffer.sampleRate;
  const sStart = Math.round((trimS||0)*sr);
  const sEnd = Math.round((trimE||buffer.duration)*sr);
  const data = data0; // use left channel
  const w = canvas.offsetWidth || 120;
  const h = canvas.height = 44;
  canvas.width = w;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);
  const step = Math.max(1, Math.ceil((sEnd-sStart)/w));
  const mid = h/2;
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let x=0;x<w;x++){
    let max=-1,min=1;
    const base = sStart + Math.round(x*(sEnd-sStart)/w);
    for(let s=0;s<step;s++){
      const v = data[base+s]||0;
      if(v>max)max=v; if(v<min)min=v;
    }
    ctx.moveTo(x, mid+min*mid*0.9);
    ctx.lineTo(x, mid+max*mid*0.9);
  }
  ctx.stroke();
  // Fade in/out overlay
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
}

function initClipDrag(el, clip, track){
  let sx, st;
  const onDown = e=>{
    if(e.target.classList.contains('clip-resize-r')) return;
    if(activeTool==='erase'||activeTool==='cut') return;
    e.stopPropagation();
    sx = e.clientX || e.touches?.[0]?.clientX;
    st = clip.startTime;
    const onMove = ev=>{
      const cx = ev.clientX||(ev.touches?.[0]?.clientX)||sx;
      const dx = cx-sx;
      clip.startTime = Math.max(0, snapTime(st + dx/PPS()));
      el.style.left = Math.round(clip.startTime*PPS())+'px';
    };
    const onUp = ()=>{
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      document.removeEventListener('touchmove',onMove);
      document.removeEventListener('touchend',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
    document.addEventListener('touchmove',onMove,{passive:true});
    document.addEventListener('touchend',onUp);
  };
  el.addEventListener('mousedown', onDown);
  el.addEventListener('touchstart', onDown, {passive:true});
}

function initClipResize(handle, clip, track){
  let sx, sd;
  const onDown = e=>{
    e.stopPropagation(); e.preventDefault();
    sx = e.clientX||(e.touches?.[0]?.clientX)||0;
    sd = clip.duration - clip.trimEnd;
    const onMove = ev=>{
      const cx = ev.clientX||(ev.touches?.[0]?.clientX)||sx;
      const dx = cx-sx;
      const newDur = Math.max(0.1, sd + dx/PPS());
      const maxDur = clip.buffer.duration - clip.trimStart;
      clip.trimEnd = Math.max(0, clip.buffer.duration - clip.trimStart - Math.min(newDur, maxDur));
      const dur = clip.duration - clip.trimStart - clip.trimEnd;
      const el = document.getElementById(`clip-${clip.id}`);
      if(el) el.style.width = Math.max(20, Math.round(dur*PPS()))+'px';
    };
    const onUp = ()=>{
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      document.removeEventListener('touchmove',onMove);
      document.removeEventListener('touchend',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
    document.addEventListener('touchmove',onMove,{passive:true});
    document.addEventListener('touchend',onUp);
  };
  handle.addEventListener('mousedown', onDown);
  handle.addEventListener('touchstart', onDown, {passive:true});
}

function removeClip(track, clipId){
  const idx = track.clips.findIndex(c=>c.id===clipId);
  if(idx===-1) return;
  track.clips.splice(idx,1);
  document.getElementById(`clip-${clipId}`)?.remove();
  if(selectedClipId===clipId) selectedClipId=null;
  notify('Clip eliminado');
}

function selectClip(clipId){
  document.querySelectorAll('.clip.selected').forEach(e=>e.classList.remove('selected'));
  selectedClipId=clipId;
  document.getElementById(`clip-${clipId}`)?.classList.add('selected');
}

function splitClipAt(track, clip, splitTime){
  if(splitTime <= clip.startTime || splitTime >= clip.startTime + clip.duration - clip.trimStart - clip.trimEnd) return;
  const leftDur = splitTime - clip.startTime;
  const rightDur = clip.duration - clip.trimStart - clip.trimEnd - leftDur;
  // Left: trim end
  clip.trimEnd = clip.buffer.duration - clip.trimStart - leftDur;
  // Right: new clip
  const newClip = addClip(track, clip.originalBuffer||clip.buffer, clip.name+' 2', splitTime, clip.color);
  newClip.trimStart = clip.trimStart + leftDur;
  newClip.duration = clip.buffer.duration;
  // Refresh both
  renderClipDOM(track, clip);
  renderClipDOM(track, newClip);
  notify('Clip dividido');
}

function duplicateClip(trackId, clipId){
  const track = tracksData.find(t=>t.id===trackId);
  if(!track) return;
  const clip = track.clips.find(c=>c.id===clipId);
  if(!clip) return;
  const dur = clip.duration - clip.trimStart - clip.trimEnd;
  const newClip = addClip(track, clip.buffer, clip.name+' (copia)', clip.startTime+dur+0.1, clip.color);
  newClip.trimStart = clip.trimStart;
  newClip.trimEnd = clip.trimEnd;
  newClip.gain = clip.gain;
  newClip.pitch = clip.pitch;
  renderClipDOM(track, newClip);
  notify('Clip duplicado');
}

function reverseClip(clip){
  const ctx = getAC();
  const orig = clip.buffer;
  const rev = ctx.createBuffer(orig.numberOfChannels, orig.length, orig.sampleRate);
  for(let c=0;c<orig.numberOfChannels;c++){
    const src = orig.getChannelData(c);
    const dst = rev.getChannelData(c);
    for(let i=0;i<src.length;i++) dst[i]=src[src.length-1-i];
  }
  clip.buffer = rev;
  clip.reversed = !clip.reversed;
  const track = tracksData.find(t=>t.id===clip.trackId);
  if(track) renderClipDOM(track, clip);
  notify('Clip invertido');
}

// ‚îÄ‚îÄ‚îÄ PLAYBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function play(){
  ensureGraph();
  if(isPlaying) return;
  isPlaying = true;
  playStartAC = getAC().currentTime;
  playStartOffset = playhead;
  document.getElementById('btn-play').textContent='‚è∏ PAUSE';
  document.getElementById('btn-play').classList.add('on');
  // ----------------------------------------------- Bot√≥n de Pausa ---------------------------------------------------------
  const now = getAC().currentTime;
  tracksData.forEach(track=>{
    track.clips.forEach(clip=>{
      if(clip.muted) return;
      const clipStart = clip.startTime;
      const trimS = clip.trimStart;
      const trimDur = clip.duration - trimS - clip.trimEnd;
      if(clipStart + trimDur < playhead) return;
      const offset = Math.max(0, playhead - clipStart) + trimS;
      const when = now + Math.max(0, clipStart - playhead);
      const src = getAC().createBufferSource();
      src.buffer = clip.buffer;
      src.playbackRate.value = Math.pow(2, clip.pitch/12);
      // Per-clip gain
      const cGain = getAC().createGain();
      cGain.gain.value = clip.gain * (track.muted ? 0 : track.volume);
      src.connect(cGain);
      cGain.connect(track.gainNode);
      src.start(when, offset, Math.max(0, trimDur - Math.max(0, playhead-clipStart)));
      track.activeSources.push(src);
    });
  });
  startRAF();
  notify('‚ñ∂ Reproduciendo...');
}

function pause(){
  if(!isPlaying) return;
  isPlaying=false;
  playhead = playStartOffset + (getAC().currentTime - playStartAC);
  tracksData.forEach(stopTrackSources);
  cancelAnimationFrame(raf);
  document.getElementById('btn-play').textContent='‚ñ∂ PLAY';
  document.getElementById('btn-play').classList.remove('on');
  notify('‚è∏ Pausado');
}

function stop(){
  isPlaying=false;
  tracksData.forEach(stopTrackSources);
  cancelAnimationFrame(raf);
  playhead=0;
  updatePlayheadDisplay();
  updateTimeDisplay(0);
  document.getElementById('btn-play').textContent='‚ñ∂ PLAY';
  document.getElementById('btn-play').classList.remove('on');
}

function startRAF(){
  const tick=()=>{
    if(!isPlaying) return;
    const elapsed = getAC().currentTime - playStartAC;
    playhead = playStartOffset + elapsed;
    const totalDur = getProjectDuration();
    if(playhead >= totalDur){
      if(isLooping){ stop(); setTimeout(play,10); return; }
      else { stop(); return; }
    }
    updatePlayheadDisplay();
    updateTimeDisplay(playhead);
    updateMeters();
    raf=requestAnimationFrame(tick);
  };
  raf=requestAnimationFrame(tick);
}

function getProjectDuration(){
  let max=16;
  tracksData.forEach(t=>t.clips.forEach(c=>{ const e=c.startTime+c.duration-c.trimStart-c.trimEnd; if(e>max) max=e; }));
  return max;
}

function updatePlayheadDisplay(){
  const px = Math.round(playhead*PPS());
  document.querySelectorAll('[id^="ph-"]').forEach(el=>el.style.left=px+'px');
  // Scroll tracks if needed
  const laneEl = document.querySelector('.track-lane');
  if(laneEl && isPlaying){
    const w = laneEl.offsetWidth;
    if(px > w * 0.8) laneEl.scrollLeft = px - w*0.4;
  }
}

function updateTimeDisplay(t){
  const m=Math.floor(t/60), s=Math.floor(t%60), cs=Math.floor((t%1)*100);
  document.getElementById('time-display').textContent=`${m}:${String(s).padStart(2,'0')}.${String(cs).padStart(2,'0')}`;
}

function updateMeters(){
  if(!masterAnalyser) return;
  const data = new Uint8Array(masterAnalyser.frequencyBinCount);
  masterAnalyser.getByteFrequencyData(data);
  const avg = data.slice(0,32).reduce((a,b)=>a+b,0)/32;
  const pct = Math.min(100, avg/128*100);
  const m1=document.getElementById('meter-master-l');
  const m2=document.getElementById('meter-master-r');
  if(m1) m1.style.height=pct+'%';
  if(m2) m2.style.height=Math.max(0,pct-5+Math.random()*8)+'%';

  tracksData.forEach(t=>{
    const m=document.getElementById(`mx-meter-${t.id}`);
    if(!m) return;
    if(isPlaying && !t.muted){
      const v=t.volume; const p=Math.min(100, (pct*v*1.1+Math.random()*8));
      m.style.height=p+'%';
    } else {
      const cur=parseFloat(m.style.height)||0;
      m.style.height=Math.max(0,cur-4)+'%';
    }
  });
}

// ‚îÄ‚îÄ‚îÄ MUTE / SOLO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMute(track){
  track.muted=!track.muted;
  track.gainNode.gain.value = track.muted ? 0 : track.volume;
  document.getElementById(`tmute-${track.id}`)?.classList.toggle('muted',track.muted);
  // update mixer
  document.getElementById(`mx-mute-${track.id}`)?.classList.toggle('muted',track.muted);
}
function toggleSolo(track){
  track.soloed=!track.soloed;
  document.getElementById(`tsolo-${track.id}`)?.classList.toggle('soloed',track.soloed);
  const hasSolo=tracksData.some(t=>t.soloed);
  tracksData.forEach(t=>{
    if(hasSolo) t.gainNode.gain.value = (t.soloed&&!t.muted)?t.volume:0;
    else t.gainNode.gain.value = t.muted?0:t.volume;
  });
}

// ‚îÄ‚îÄ‚îÄ RULER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawRuler(){
  const canvas=document.getElementById('ruler-canvas');
  const wrap=document.getElementById('ruler-scroll');
  const w=Math.max(wrap.offsetWidth, getProjectDuration()*PPS()+200);
  canvas.width=w; canvas.height=24;
  const ctx2d=canvas.getContext('2d');
  ctx2d.clearRect(0,0,w,24);
  ctx2d.fillStyle='#0d0d1a'; ctx2d.fillRect(0,0,w,24);
  const ppb=PPB(), pps=PPS();
  const barsVisible=Math.ceil(w/ppb)+1;
  ctx2d.font='9px DM Mono'; ctx2d.textAlign='left';
  for(let b=0;b<barsVisible;b++){
    const x=b*ppb;
    const isBar=(b%timeSignature===0);
    ctx2d.strokeStyle=isBar?'#303060':'#1e1e3a';
    ctx2d.lineWidth=isBar?1.5:0.5;
    ctx2d.beginPath(); ctx2d.moveTo(x,0); ctx2d.lineTo(x,24); ctx2d.stroke();
    if(isBar){
      ctx2d.fillStyle='#505080';
      ctx2d.fillText(String(Math.floor(b/timeSignature)+1), x+2, 16);
    }
  }
  // Loop region
  ctx2d.fillStyle='rgba(232,255,0,0.06)';
  ctx2d.fillRect(loopStart*pps, 0, (loopEnd-loopStart)*pps, 24);
  ctx2d.fillStyle='rgba(232,255,0,0.5)';
  ctx2d.fillRect(loopStart*pps, 0, 2, 24);
  ctx2d.fillRect(loopEnd*pps-2, 0, 2, 24);
  // Playhead marker
  ctx2d.fillStyle='var(--accent2,#ff2d6b)';
  const phx=playhead*pps;
  ctx2d.fillStyle='#ff2d6b';
  ctx2d.fillRect(phx, 0, 2, 24);
}

document.getElementById('ruler-canvas').addEventListener('click', e=>{
  const rect=e.currentTarget.getBoundingClientRect();
  playhead=Math.max(0,(e.clientX-rect.left)/PPS());
  updatePlayheadDisplay(); updateTimeDisplay(playhead); drawRuler();
});

// ‚îÄ‚îÄ‚îÄ MIXER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMixer(){
  const inner=document.getElementById('mixer-inner');
  inner.innerHTML='';
  tracksData.forEach(track=>{
    const ch=document.createElement('div');
    ch.className='mx-ch'; ch.id=`mx-ch-${track.id}`;
    const fillH=Math.round(track.volume*100);
    const colorBorder=track.color.border;
    ch.innerHTML=`
      <div class="mx-ch-name" style="color:${colorBorder}">${track.name.substring(0,8)}</div>
      <div class="mx-meter-wrap">
        <div class="mx-meter">
          <div class="mx-meter-fill" id="mx-meter-${track.id}"
            style="height:${fillH/2}%;background:linear-gradient(to top,var(--green),var(--yellow) 70%,var(--red) 90%)"></div>
        </div>
      </div>
      <div class="mx-fader-wrap">
        <div class="mx-fader-track" id="mx-fader-${track.id}">
          <div class="mx-fader-fill" id="mx-fader-fill-${track.id}"
            style="height:${fillH}%;background:${colorBorder}44"></div>
          <div class="mx-fader-thumb" id="mx-fader-thumb-${track.id}"
            style="bottom:${Math.max(0,fillH-4)}%;border-color:${colorBorder}"></div>
        </div>
      </div>
      <div class="mx-send-lbl" style="color:${colorBorder}">${Math.round(track.volume*100)}%</div>
      <div style="display:flex;gap:2px;margin-top:2px">
        <button class="th-btn ${track.muted?'muted':''}" id="mx-mute-${track.id}" style="font-size:7px">M</button>
        <button class="th-btn ${track.soloed?'soloed':''}" id="mx-solo-${track.id}" style="font-size:7px">S</button>
      </div>
    `;
    inner.appendChild(ch);
    initMixerFaderDrag(ch, track);
    ch.querySelector(`#mx-mute-${track.id}`).addEventListener('click',()=>toggleMute(track));
    ch.querySelector(`#mx-solo-${track.id}`).addEventListener('click',()=>toggleSolo(track));
  });

  // Master
  const master=document.createElement('div');
  master.className='mx-ch mx-master';
  master.innerHTML=`
    <div class="mx-master-lbl">MASTER</div>
    <div class="mx-meter-wrap">
      <div class="mx-meter"><div class="mx-meter-fill" id="meter-master-l"
        style="height:40%;background:linear-gradient(to top,var(--green),var(--yellow) 70%,var(--red) 90%)"></div></div>
      <div class="mx-meter"><div class="mx-meter-fill" id="meter-master-r"
        style="height:38%;background:linear-gradient(to top,var(--green),var(--yellow) 70%,var(--red) 90%)"></div></div>
    </div>
    <div class="mx-fader-wrap">
      <div class="mx-fader-track" id="mx-fader-master">
        <div class="mx-fader-fill" id="mx-fader-fill-master" style="height:80%;background:rgba(232,255,0,0.3)"></div>
        <div class="mx-fader-thumb" id="mx-fader-thumb-master" style="bottom:76%;border-color:var(--accent)"></div>
      </div>
    </div>
    <div class="mx-send-lbl" id="mx-master-val">80%</div>
    <div class="mx-eq-mini">
      <div style="display:flex;flex-direction:column;align-items:center;gap:1px">
        <input type="range" id="mx-eq-lo" min="-12" max="12" value="0" orient="vertical" style="writing-mode:vertical-lr;direction:rtl;height:40px;width:14px;-webkit-appearance:slider-vertical;accent-color:var(--accent)">
        <span style="font-size:7px;color:var(--text3)">LO</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:1px">
        <input type="range" id="mx-eq-mid" min="-12" max="12" value="0" orient="vertical" style="writing-mode:vertical-lr;direction:rtl;height:40px;width:14px;-webkit-appearance:slider-vertical;accent-color:var(--accent3)">
        <span style="font-size:7px;color:var(--text3)">MD</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:1px">
        <input type="range" id="mx-eq-hi" min="-12" max="12" value="0" orient="vertical" style="writing-mode:vertical-lr;direction:rtl;height:40px;width:14px;-webkit-appearance:slider-vertical;accent-color:var(--accent2)">
        <span style="font-size:7px;color:var(--text3)">HI</span>
      </div>
    </div>
  `;
  inner.appendChild(master);

  // Master fader drag
  const mft=document.getElementById('mx-fader-master');
  if(mft) initMasterFaderDrag(mft);

  // Master EQ
  ['lo','mid','hi'].forEach(band=>{
    document.getElementById(`mx-eq-${band}`)?.addEventListener('input', e=>{
      const v=parseFloat(e.target.value);
      if(band==='lo'&&eqLo) eqLo.gain.value=v;
      if(band==='mid'&&eqLomid) eqLomid.gain.value=v;
      if(band==='hi'&&eqHi) eqHi.gain.value=v;
    });
  });
}

function refreshMixerName(track){
  const el=document.querySelector(`#mx-ch-${track.id} .mx-ch-name`);
  if(el) el.textContent=track.name.substring(0,8);
}

function updateMixerFader(track){
  const fillH=Math.round(track.volume*100);
  const fill=document.getElementById(`mx-fader-fill-${track.id}`);
  const thumb=document.getElementById(`mx-fader-thumb-${track.id}`);
  const lbl=document.querySelector(`#mx-ch-${track.id} .mx-send-lbl`);
  if(fill) fill.style.height=fillH+'%';
  if(thumb) thumb.style.bottom=Math.max(0,fillH-4)+'%';
  if(lbl) lbl.textContent=Math.round(track.volume*100)+'%';
}

function initMixerFaderDrag(ch, track){
  const thumb=ch.querySelector('.mx-fader-thumb');
  if(!thumb) return;
  let sy, sv;
  const onDown=e=>{
    sy=e.clientY||(e.touches?.[0]?.clientY)||0; sv=track.volume;
    const onMove=ev=>{
      const cy=ev.clientY||(ev.touches?.[0]?.clientY)||sy;
      const dy=(sy-cy)/100;
      track.volume=Math.max(0,Math.min(1.5,sv+dy));
      track.gainNode.gain.value=track.muted?0:track.volume;
      document.getElementById(`vol-sl-${track.id}`).value=Math.round(track.volume*100);
      document.getElementById(`vol-val-${track.id}`).textContent=Math.round(track.volume*100)+'%';
      updateMixerFader(track);
    };
    const onUp=()=>{
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      document.removeEventListener('touchmove',onMove);
      document.removeEventListener('touchend',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
    document.addEventListener('touchmove',onMove,{passive:true});
    document.addEventListener('touchend',onUp);
  };
  thumb.addEventListener('mousedown',onDown);
  thumb.addEventListener('touchstart',onDown,{passive:true});
}

function initMasterFaderDrag(fader){
  const thumb=document.getElementById('mx-fader-thumb-master');
  if(!thumb) return;
  let sy, sv;
  const onDown=e=>{
    sy=e.clientY||(e.touches?.[0]?.clientY)||0;
    sv=masterGain ? masterGain.gain.value : 0.8;
    const onMove=ev=>{
      const cy=ev.clientY||(ev.touches?.[0]?.clientY)||sy;
      const dy=(sy-cy)/100;
      const newV=Math.max(0,Math.min(1.2,sv+dy));
      if(masterGain) masterGain.gain.value=newV;
      const pct=Math.round(newV*100);
      document.getElementById('mx-fader-fill-master').style.height=pct+'%';
      thumb.style.bottom=Math.max(0,pct-4)+'%';
      document.getElementById('mx-master-val').textContent=pct+'%';
      document.querySelector('[data-fx="master-vol"]')?.setAttribute('data-val',pct);
      updateKnobVisual(document.querySelector('[data-fx="master-vol"]'),pct);
    };
    const onUp=()=>{
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  };
  thumb.addEventListener('mousedown',onDown);
}

// ‚îÄ‚îÄ‚îÄ FX KNOBS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateKnobVisual(knob, val){
  if(!knob) return;
  const min=parseFloat(knob.dataset.min||0);
  const max=parseFloat(knob.dataset.max||100);
  const pct=(val-min)/(max-min);
  const angle = -135 + pct*270; // -135 to +135 degrees
  knob.style.setProperty('--rot', angle+'deg');
  knob.querySelector ? null : null;
  // Use pseudo element via CSS variable
  knob.style.transform='none'; // pseudo handles rotation
  const marker=knob._marker;
  if(!marker) {
    const m=document.createElement('div');
    m.style.cssText='position:absolute;width:3px;height:10px;background:inherit;border-radius:2px;left:50%;top:3px;transform-origin:bottom center;pointer-events:none';
    knob.appendChild(m);
    knob._marker=m;
  }
  knob._marker.style.background=knob.style.borderColor||'var(--accent)';
  knob._marker.style.transform=`translateX(-50%) rotate(${angle}deg)`;
  knob._marker.style.background=getFxKnobColor(knob.dataset.fx);
}

function getFxKnobColor(fx){
  if(fx?.startsWith('reverb')) return 'var(--accent3)';
  if(fx?.startsWith('delay')) return 'var(--accent4)';
  if(fx?.startsWith('eq')) return 'var(--accent)';
  if(fx?.startsWith('comp')) return 'var(--orange)';
  if(fx?.startsWith('dist')) return 'var(--red)';
  if(fx?.startsWith('filter')) return 'var(--accent2)';
  if(fx?.startsWith('master')) return 'var(--yellow)';
  return 'var(--accent)';
}

function applyFx(fx, val){
  const ctx=getAC(); if(!ctx) return;
  const v=parseFloat(val);
  switch(fx){
    case 'reverb-wet': if(reverbWetGain) reverbWetGain.gain.value=v/100*0.8; break;
    case 'reverb-decay': buildImpulse(0.1+v/100*4); break;
    case 'delay-time': if(delayNode) delayNode.delayTime.value=v/100*1.5; break;
    case 'delay-feedback': if(delayFeedbackGain) delayFeedbackGain.gain.value=v/100*0.85; break;
    case 'delay-mix': if(delayWetGain) delayWetGain.gain.value=v/100*0.8; break;
    case 'eq-lo': if(eqLo) eqLo.gain.value=(v-50)/50*12; break;
    case 'eq-mid': if(eqLomid) eqLomid.gain.value=(v-50)/50*12; break;
    case 'eq-hi': if(eqHi) eqHi.gain.value=(v-50)/50*12; break;
    case 'eq-presence': if(eqPresence) eqPresence.gain.value=(v-50)/50*12; break;
    case 'comp-threshold': if(compressor) compressor.threshold.value=-60+(v/100*55); break;
    case 'comp-ratio': if(compressor) compressor.ratio.value=1+v/100*19; break;
    case 'comp-makeup': if(compressor) compressor.attack.value=0.001+(1-v/100)*0.1; break;
    case 'dist-amount': buildDistCurve(v*5); break;
    case 'dist-mix': if(distWetGain) distWetGain.gain.value=v/100; if(distDryGain) distDryGain.gain.value=1-v/100*0.5; break;
    case 'filter-freq': if(filterNode) filterNode.frequency.value=20+Math.pow(v/100,3)*20000; break;
    case 'filter-res': if(filterNode) filterNode.Q.value=v/10; break;
    case 'master-vol': if(masterGain) masterGain.gain.value=v/100; break;
    case 'master-limiter': if(limiterNode) limiterNode.threshold.value=-20+v/100*19; break;
  }
}

function initKnobs(){
  document.querySelectorAll('.fx-knob').forEach(knob=>{
    const val=parseFloat(knob.dataset.val)||50;
    updateKnobVisual(knob, val);
    let startY, startVal;
    const onDown=e=>{
      e.preventDefault();
      startY=e.clientY||(e.touches?.[0]?.clientY)||0;
      startVal=parseFloat(knob.dataset.val)||50;
      const min=parseFloat(knob.dataset.min||0);
      const max=parseFloat(knob.dataset.max||100);
      const onMove=ev=>{
        const cy=ev.clientY||(ev.touches?.[0]?.clientY)||startY;
        const dy=startY-cy;
        const newVal=Math.max(min,Math.min(max, startVal+dy*(max-min)/150));
        knob.dataset.val=newVal;
        updateKnobVisual(knob, newVal);
        ensureGraph();
        applyFx(knob.dataset.fx, newVal);
      };
      const onUp=()=>{
        document.removeEventListener('mousemove',onMove);
        document.removeEventListener('mouseup',onUp);
        document.removeEventListener('touchmove',onMove);
        document.removeEventListener('touchend',onUp);
      };
      document.addEventListener('mousemove',onMove);
      document.addEventListener('mouseup',onUp);
      document.addEventListener('touchmove',onMove,{passive:false});
      document.addEventListener('touchend',onUp);
    };
    knob.addEventListener('mousedown',onDown);
    knob.addEventListener('touchstart',onDown,{passive:false});
    // Double-click to reset
    knob.addEventListener('dblclick',()=>{
      const mid=(parseFloat(knob.dataset.min||0)+parseFloat(knob.dataset.max||100))/2;
      knob.dataset.val=knob.dataset.fx?.includes('eq')?50:parseFloat(knob.dataset.val);
      // Reset to sensible default
      const defaults={'reverb-wet':20,'reverb-decay':40,'delay-time':30,'delay-feedback':25,
        'delay-mix':30,'eq-lo':50,'eq-mid':50,'eq-hi':50,'eq-presence':50,
        'comp-threshold':40,'comp-ratio':30,'comp-makeup':50,'dist-amount':0,'dist-mix':0,
        'filter-freq':80,'filter-res':10,'master-vol':80,'master-limiter':90};
      const def=defaults[knob.dataset.fx]??50;
      knob.dataset.val=def;
      updateKnobVisual(knob,def);
      applyFx(knob.dataset.fx,def);
    });
  });
}

// FX Toggles
['reverb','delay','comp','dist'].forEach(fx=>{
  document.getElementById(`toggle-${fx}`)?.addEventListener('click', function(){
    fxEnabled[fx]=!fxEnabled[fx];
    this.textContent=fxEnabled[fx]?'ON':'OFF';
    this.classList.toggle('on',fxEnabled[fx]);
    if(fx==='reverb' && reverbWetGain) reverbWetGain.gain.value=fxEnabled[fx]?parseFloat(document.querySelector('[data-fx="reverb-wet"]')?.dataset.val||20)/100*0.8:0;
    if(fx==='delay' && delayWetGain) delayWetGain.gain.value=fxEnabled[fx]?parseFloat(document.querySelector('[data-fx="delay-mix"]')?.dataset.val||30)/100*0.8:0;
    if(fx==='comp' && compressor){ if(!fxEnabled[fx]) compressor.ratio.value=1; else compressor.ratio.value=4; }
    if(fx==='dist' && distWetGain) distWetGain.gain.value=fxEnabled[fx]?parseFloat(document.querySelector('[data-fx="dist-mix"]')?.dataset.val||0)/100:0;
    notify(fx.toUpperCase()+' '+(fxEnabled[fx]?'activado':'desactivado'));
  });
  // Set initial state
  document.getElementById(`toggle-${fx}`)?.classList.toggle('on', fxEnabled[fx]);
});

document.getElementById('filter-type')?.addEventListener('change', e=>{
  if(filterNode) filterNode.type=e.target.value;
});

// ‚îÄ‚îÄ‚îÄ BPM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function changeBpm(delta){
  bpm=Math.max(40,Math.min(300,bpm+delta));
  document.getElementById('bpm-display').textContent=bpm;
  document.getElementById('bpmSlider').value=bpm;
  drawRuler();
}
document.getElementById('bpmSlider').addEventListener('input', e=>{
  bpm=parseInt(e.target.value);
  document.getElementById('bpm-display').textContent=bpm;
  drawRuler();
});
let bpmHold;
document.getElementById('bpm-display').addEventListener('dblclick', ()=>{
  const v=prompt('Introduce BPM:',bpm);
  if(v&&!isNaN(v)) changeBpm(parseInt(v)-bpm);
});

// ‚îÄ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('zoom-sl').addEventListener('input', e=>{
  zoom=parseFloat(e.target.value);
  document.getElementById('zoom-val').textContent=zoom.toFixed(1)+'√ó';
  reRenderAllClips();
  drawRuler();
});

function reRenderAllClips(){
  tracksData.forEach(track=>{
    const li=document.getElementById(`lane-inner-${track.id}`);
    if(li){ li.style.minWidth=(getProjectDuration()+30)*PPS()+'px'; }
    track.clips.forEach(clip=>renderClipDOM(track,clip));
  });
}

// ‚îÄ‚îÄ‚îÄ FILE LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFilesToTrack(track, files, startT){
  let t=startT||0;
  for(const file of files){
    if(!file.type.startsWith('audio/')) continue;
    setStatus('Cargando '+file.name+'...');
    const arr=await file.arrayBuffer();
    try{
      const buf=await getAC().decodeAudioData(arr);
      addClip(track, buf, file.name.replace(/\.[^.]+$/,''), snapTime(t));
      t+=buf.duration+0.2;
      notify(`‚úì ${file.name}`,'success');
    } catch(e){ notify(`‚úó Error: ${file.name}`,'error'); }
  }
  setStatus('LISTO');
  drawRuler();
}

document.getElementById('file-input').addEventListener('change', async e=>{
  if(!e.target.files.length) return;
  let t=tracksData[tracksData.length-1];
  if(!t) t=createTrack();
  await loadFilesToTrack(t, e.target.files, 0);
  e.target.value='';
});

// Library file drop
document.getElementById('lib-drop-zone').addEventListener('click', ()=>document.getElementById('lib-file-input').click());
document.getElementById('lib-file-input').addEventListener('change', async e=>{
  for(const file of e.target.files){
    if(!file.type.startsWith('audio/')) continue;
    const arr=await file.arrayBuffer();
    try{
      const buf=await getAC().decodeAudioData(arr);
      const item={
        id:'user-'+Date.now()+'-'+file.name,
        name: file.name.replace(/\.[^.]+$/,''),
        cat:'drums', icon:'üéµ', duration:buf.duration,
        buffer:buf, user:true, bpm:null
      };
      libraryItems.unshift(item);
      renderLibrary();
      notify(`‚úì ${file.name} a√±adido a librer√≠a`,'success');
    } catch(e){ notify('Error: '+file.name,'error'); }
  }
  e.target.value='';
});
document.getElementById('lib-drop-zone').addEventListener('dragover', e=>{e.preventDefault();e.currentTarget.classList.add('over');});
document.getElementById('lib-drop-zone').addEventListener('dragleave', e=>e.currentTarget.classList.remove('over'));
document.getElementById('lib-drop-zone').addEventListener('drop', async e=>{
  e.preventDefault(); e.currentTarget.classList.remove('over');
  if(!e.dataTransfer.files.length) return;
  for(const file of e.dataTransfer.files){
    if(!file.type.startsWith('audio/')) continue;
    const arr=await file.arrayBuffer();
    try{
      const buf=await getAC().decodeAudioData(arr);
      const item={id:'user-'+Date.now()+'-'+file.name,name:file.name.replace(/\.[^.]+$/,''),
        cat:'drums',icon:'üéµ',duration:buf.duration,buffer:buf,user:true,bpm:null};
      libraryItems.unshift(item);
      renderLibrary();
      notify(`‚úì ${file.name}`,'success');
    }catch(e){}
  }
});

// Global drop
document.body.addEventListener('dragover', e=>{ if(!e.target.closest('#lib-panel')) e.preventDefault(); });
document.body.addEventListener('drop', async e=>{
  if(e.target.closest('#lib-panel')) return;
  e.preventDefault();
  if(!e.dataTransfer.files.length) return;
  let t=tracksData[tracksData.length-1]||createTrack();
  await loadFilesToTrack(t, e.dataTransfer.files, 0);
});

// ‚îÄ‚îÄ‚îÄ CLIP EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openClipEditor(clip, track){
  clipEditorClip={clip,track};
  document.getElementById('clip-editor').classList.add('open');
  document.getElementById('ce-clip-name').textContent=clip.name;
  document.getElementById('ce-gain').value=Math.round(clip.gain*100);
  document.getElementById('ce-gain-val').textContent=Math.round(clip.gain*100)+'%';
  document.getElementById('ce-pitch').value=clip.pitch;
  document.getElementById('ce-pitch-val').textContent=clip.pitch;
  document.getElementById('ce-fadein').value=Math.round(clip.fadeIn*100);
  document.getElementById('ce-fadeout').value=Math.round(clip.fadeOut*100);
  document.getElementById('ce-reverse').checked=clip.reversed;
  trimStart=clip.trimStart; trimEnd=clip.trimEnd;
  document.getElementById('trim-s-val').textContent=trimStart.toFixed(2)+'s';
  document.getElementById('trim-e-val').textContent=(clip.buffer.duration-trimEnd).toFixed(2)+'s';
  setTimeout(()=>drawClipEditorWave(clip),50);
  setupCETrimHandles(clip);
}

function drawClipEditorWave(clip){
  const canvas=document.getElementById('ce-canvas');
  const wrap=document.getElementById('ce-wave-wrap');
  canvas.width=wrap.offsetWidth||400;
  canvas.height=wrap.offsetHeight||120;
  const ctx2d=canvas.getContext('2d');
  ctx2d.clearRect(0,0,canvas.width,canvas.height);
  ctx2d.fillStyle='var(--bg2)'; ctx2d.fillRect(0,0,canvas.width,canvas.height);
  const buf=clip.buffer;
  const data=buf.getChannelData(0);
  const w=canvas.width, h=canvas.height;
  ctx2d.strokeStyle=clip.color.border; ctx2d.lineWidth=1.2;
  ctx2d.beginPath();
  const step=Math.max(1,Math.ceil(data.length/w));
  const mid=h/2;
  for(let x=0;x<w;x++){
    let max=-1,min=1;
    const base=Math.round(x*data.length/w);
    for(let s=0;s<step&&base+s<data.length;s++){
      const v=data[base+s];
      if(v>max)max=v;if(v<min)min=v;
    }
    ctx2d.moveTo(x,mid+min*mid*0.85);
    ctx2d.lineTo(x,mid+max*mid*0.85);
  }
  ctx2d.stroke();

  // Trim region
  const ls=trimStart/buf.duration*w;
  const re=(1-trimEnd/buf.duration)*w;
  ctx2d.fillStyle='rgba(0,0,0,0.5)';
  ctx2d.fillRect(0,0,ls,h);
  ctx2d.fillRect(re,0,w-re,h);
  ctx2d.strokeStyle=clip.color.border;
  ctx2d.lineWidth=2;
  ctx2d.beginPath();ctx2d.moveTo(ls,0);ctx2d.lineTo(ls,h);ctx2d.stroke();
  ctx2d.beginPath();ctx2d.moveTo(re,0);ctx2d.lineTo(re,h);ctx2d.stroke();

  // Update region div
  const region=document.getElementById('ce-region');
  region.style.left=ls+'px';
  region.style.width=(re-ls)+'px';
}

function setupCETrimHandles(clip){
  const canvas=document.getElementById('ce-canvas');
  const lh=document.getElementById('ce-handle-l');
  const rh=document.getElementById('ce-handle-r');
  const wrap=document.getElementById('ce-wave-wrap');

  const dragHandle=(handle, isLeft)=>{
    let sx;
    const onDown=e=>{
      sx=e.clientX||(e.touches?.[0]?.clientX)||0;
      const onMove=ev=>{
        const cx=ev.clientX||(ev.touches?.[0]?.clientX)||sx;
        const rect=wrap.getBoundingClientRect();
        const x=cx-rect.left;
        const t=Math.max(0,Math.min(1,x/rect.width))*clip.buffer.duration;
        if(isLeft){
          trimStart=Math.max(0,Math.min(t, clip.buffer.duration-trimEnd-0.1));
          document.getElementById('trim-s-val').textContent=trimStart.toFixed(2)+'s';
        } else {
          trimEnd=Math.max(0,Math.min(clip.buffer.duration-t, clip.buffer.duration-trimStart-0.1));
          document.getElementById('trim-e-val').textContent=(clip.buffer.duration-trimEnd).toFixed(2)+'s';
        }
        drawClipEditorWave(clip);
      };
      const onUp=()=>{
        document.removeEventListener('mousemove',onMove);
        document.removeEventListener('mouseup',onUp);
        document.removeEventListener('touchmove',onMove);
        document.removeEventListener('touchend',onUp);
      };
      document.addEventListener('mousemove',onMove);
      document.addEventListener('mouseup',onUp);
      document.addEventListener('touchmove',onMove,{passive:true});
      document.addEventListener('touchend',onUp);
    };
    handle.addEventListener('mousedown',e=>{e.stopPropagation();onDown(e);});
    handle.addEventListener('touchstart',e=>{e.stopPropagation();onDown(e);},{passive:true});
  };
  dragHandle(lh, true);
  dragHandle(rh, false);
}

document.getElementById('ce-gain').addEventListener('input', e=>{
  document.getElementById('ce-gain-val').textContent=e.target.value+'%';
  if(clipEditorClip) clipEditorClip.clip.gain=e.target.value/100;
});
document.getElementById('ce-pitch').addEventListener('input', e=>{
  document.getElementById('ce-pitch-val').textContent=e.target.value;
  if(clipEditorClip) clipEditorClip.clip.pitch=parseFloat(e.target.value);
});
document.getElementById('ce-apply').addEventListener('click', ()=>{
  if(!clipEditorClip) return;
  const {clip,track}=clipEditorClip;
  clip.trimStart=trimStart;
  clip.trimEnd=trimEnd;
  clip.fadeIn=document.getElementById('ce-fadein').value/100;
  clip.fadeOut=document.getElementById('ce-fadeout').value/100;
  if(document.getElementById('ce-reverse').checked !== clip.reversed) reverseClip(clip);
  renderClipDOM(track,clip);
  notify('Cambios aplicados','success');
});
document.getElementById('ce-split').addEventListener('click', ()=>{
  if(!clipEditorClip) return;
  const {clip,track}=clipEditorClip;
  const midT=clip.startTime+(trimStart+(clip.buffer.duration-trimEnd-trimStart)*0.5);
  splitClipAt(track,clip,midT);
  document.getElementById('clip-editor').classList.remove('open');
});
document.getElementById('ce-close').addEventListener('click', ()=>document.getElementById('clip-editor').classList.remove('open'));

// ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showContextMenu(x, y){
  const menu=document.getElementById('ctx-menu');
  menu.style.left=Math.min(x, window.innerWidth-170)+'px';
  menu.style.top=Math.min(y, window.innerHeight-200)+'px';
  menu.classList.add('show');
}
document.addEventListener('click', ()=>document.getElementById('ctx-menu').classList.remove('show'));
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ document.getElementById('ctx-menu').classList.remove('show'); document.getElementById('clip-editor').classList.remove('open'); } });

document.getElementById('ctx-edit').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  const c=t?.clips.find(c=>c.id===contextClipId);
  if(t&&c) openClipEditor(c,t);
});
document.getElementById('ctx-split').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  const c=t?.clips.find(c=>c.id===contextClipId);
  if(t&&c) splitClipAt(t,c,contextX/(PPS())+0); // approximate
});
document.getElementById('ctx-duplicate').addEventListener('click', ()=>duplicateClip(contextTrackId, contextClipId));
document.getElementById('ctx-color').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  const c=t?.clips.find(c=>c.id===contextClipId);
  if(!c) return;
  const idx=TRACK_COLORS.indexOf(c.color)+1;
  c.color=TRACK_COLORS[idx%TRACK_COLORS.length];
  renderClipDOM(t,c);
});
document.getElementById('ctx-mute-clip').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  const c=t?.clips.find(c=>c.id===contextClipId);
  if(!c) return;
  c.muted=!c.muted;
  renderClipDOM(t,c);
});
document.getElementById('ctx-reverse').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  const c=t?.clips.find(c=>c.id===contextClipId);
  if(t&&c) reverseClip(c);
});
document.getElementById('ctx-delete').addEventListener('click', ()=>{
  const t=tracksData.find(t=>t.id===contextTrackId);
  if(t) removeClip(t,contextClipId);
});

// ‚îÄ‚îÄ‚îÄ TRANSPORT BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-play').addEventListener('click', ()=>{ if(isPlaying)pause(); else play(); });
document.getElementById('btn-stop').addEventListener('click', stop);
document.getElementById('btn-rewind').addEventListener('click', ()=>{ stop(); playhead=0; updatePlayheadDisplay(); drawRuler(); });
document.getElementById('btn-rec').addEventListener('click', function(){
  isRecording=!isRecording;
  this.classList.toggle('rec-on',isRecording);
  if(isRecording) startMicRecording(); else stopMicRecording();
});
document.getElementById('btn-loop').addEventListener('click', function(){
  isLooping=!isLooping;
  this.classList.toggle('on',isLooping);
});
document.getElementById('btn-add-track').addEventListener('click', ()=>{ createTrack(); notify('Nueva pista a√±adida'); });
document.getElementById('btn-library').addEventListener('click', ()=>document.getElementById('lib-panel').classList.toggle('open'));
document.getElementById('lib-close').addEventListener('click', ()=>document.getElementById('lib-panel').classList.remove('open'));
document.getElementById('btn-export').addEventListener('click', ()=>document.getElementById('export-modal').classList.add('show'));

// ‚îÄ‚îÄ‚îÄ MIC RECORDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mediaRecorder, micChunks=[], micStream;
async function startMicRecording(){
  try{
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    const dest=getAC().createMediaStreamDestination();
    const src=getAC().createMediaStreamSource(micStream);
    src.connect(masterGain);
    mediaRecorder=new MediaRecorder(micStream);
    micChunks=[];
    mediaRecorder.ondataavailable=e=>micChunks.push(e.data);
    mediaRecorder.onstop=async ()=>{
      const blob=new Blob(micChunks,{type:'audio/webm'});
      const arr=await blob.arrayBuffer();
      const buf=await getAC().decodeAudioData(arr);
      let t=tracksData.find(t=>t.name.includes('REC'))||createTrack('REC '+new Date().toLocaleTimeString());
      addClip(t,buf,'Grabaci√≥n',playhead);
      notify('‚úì Grabaci√≥n guardada','success');
    };
    mediaRecorder.start();
    if(!isPlaying) play();
    notify('‚è∫ Grabando micr√≥fono...','success');
  }catch(e){ notify('Error: permiso de micr√≥fono denegado','error'); isRecording=false; document.getElementById('btn-rec').classList.remove('rec-on'); }
}
function stopMicRecording(){
  if(mediaRecorder?.state==='recording') mediaRecorder.stop();
  micStream?.getTracks().forEach(t=>t.stop());
  notify('‚èπ Grabaci√≥n terminada');
}

// ‚îÄ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['select','pencil','cut','erase'].forEach(tool=>{
  document.getElementById(`tool-${tool}`)?.addEventListener('click', ()=>{
    activeTool=tool;
    document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('on'));
    document.getElementById(`tool-${tool}`)?.classList.add('on');
    document.querySelectorAll('.track-lane').forEach(lane=>lane.style.cursor=
      tool==='pencil'?'crosshair':tool==='cut'?'col-resize':tool==='erase'?'cell':'default');
  });
});

document.getElementById('btn-snap').addEventListener('click', function(){
  snap=!snap; this.classList.toggle('on',snap);
  notify('Snap '+(snap?'activado':'desactivado'));
});

// ‚îÄ‚îÄ‚îÄ MIXER TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-mixer-toggle').addEventListener('click', function(){
  const ms=document.getElementById('mixer-section');
  ms.classList.toggle('collapsed');
  this.classList.toggle('on',!ms.classList.contains('collapsed'));
});
document.getElementById('btn-fx-toggle').addEventListener('click', function(){
  document.getElementById('fxbar').classList.toggle('collapsed');
  this.classList.toggle('on',!document.getElementById('fxbar').classList.contains('collapsed'));
  document.getElementById('fxbar-toggle').textContent=document.getElementById('fxbar').classList.contains('collapsed')?'‚ñº':'‚ñ≤';
});
document.getElementById('fxbar-toggle').addEventListener('click', ()=>{
  document.getElementById('fxbar').classList.toggle('collapsed');
  document.getElementById('fxbar-toggle').textContent=document.getElementById('fxbar').classList.contains('collapsed')?'‚ñº':'‚ñ≤';
});

// ‚îÄ‚îÄ‚îÄ LIBRARY FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.lib-cat').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.lib-cat').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    libFilter=btn.dataset.cat;
    renderLibrary();
  });
});
document.getElementById('lib-search').addEventListener('input', e=>{
  libSearch=e.target.value;
  renderLibrary();
});

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.fmt-opt').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.fmt-opt').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    exportFormat=btn.dataset.fmt;
  });
});
document.getElementById('btn-cancel-exp').addEventListener('click', ()=>document.getElementById('export-modal').classList.remove('show'));
document.getElementById('btn-do-export').addEventListener('click', doExport);

async function doExport(){
  ensureGraph();
  const name=document.getElementById('exp-name').value||'mezcla';
  const sr=parseInt(document.getElementById('exp-sr').value);
  const prog=document.getElementById('exp-progress');
  const fill=document.getElementById('exp-prog-fill');
  const status=document.getElementById('exp-status');
  prog.style.display='block'; fill.style.width='5%';
  status.textContent='Preparando render...';

  const dur=Math.max(4, getProjectDuration()+0.5);
  const offCtx=new OfflineAudioContext(2, Math.round(sr*dur), sr);

  // Rebuild graph offline
  const offMaster=offCtx.createGain(); offMaster.gain.value=masterGain?.gain.value||0.8;
  const offLimiter=offCtx.createDynamicsCompressor();
  offLimiter.threshold.value=-1; offLimiter.ratio.value=20;
  offMaster.connect(offLimiter); offLimiter.connect(offCtx.destination);

  // EQ
  const oEqLo=offCtx.createBiquadFilter(); oEqLo.type='lowshelf'; oEqLo.frequency.value=80; oEqLo.gain.value=eqLo?.gain.value||0;
  const oEqMid=offCtx.createBiquadFilter(); oEqMid.type='peaking'; oEqMid.frequency.value=500; oEqMid.gain.value=eqLomid?.gain.value||0;
  const oEqHi=offCtx.createBiquadFilter(); oEqHi.type='highshelf'; oEqHi.frequency.value=10000; oEqHi.gain.value=eqHi?.gain.value||0;
  oEqLo.connect(oEqMid); oEqMid.connect(oEqHi); oEqHi.connect(offMaster);

  // Reverb
  const oRev=offCtx.createConvolver(); oRev.buffer=reverbConvolver?.buffer||null;
  const oRevWet=offCtx.createGain(); oRevWet.gain.value=fxEnabled.reverb?(reverbWetGain?.gain.value||0):0;
  const oRevDry=offCtx.createGain(); oRevDry.gain.value=1;

  fill.style.width='15%'; status.textContent='Creando cadena de audio...';
  let clipCount=0;
  tracksData.forEach(track=>{
    if(track.muted) return;
    const tg=offCtx.createGain(); tg.gain.value=track.volume;
    const tp=offCtx.createStereoPanner?offCtx.createStereoPanner():null;
    if(tp){ tp.pan.value=track.pan||0; tg.connect(tp); tp.connect(oEqLo); }
    else { tg.connect(oEqLo); }
    if(oRev){ tg.connect(oRevDry); tg.connect(oRev); oRev.connect(oRevWet); oRevDry.connect(offMaster); oRevWet.connect(offMaster); }
    track.clips.forEach(clip=>{
      if(clip.muted) return;
      const src=offCtx.createBufferSource();
      src.buffer=clip.buffer;
      src.playbackRate.value=Math.pow(2,clip.pitch/12);
      const cg=offCtx.createGain(); cg.gain.value=clip.gain;
      src.connect(cg); cg.connect(tg);
      src.start(clip.startTime, clip.trimStart, clip.duration-clip.trimStart-clip.trimEnd);
      clipCount++;
    });
  });

  fill.style.width='30%'; status.textContent=`Renderizando ${clipCount} clips...`;
  let rendered;
  try{ rendered=await offCtx.startRendering(); }
  catch(e){ status.textContent='Error: '+e.message; fill.style.width='0'; return; }

  fill.style.width='70%'; status.textContent='Codificando...';
  const wav=bufToWav(rendered);
  fill.style.width='90%';

  let blob=wav, ext='wav';
  if(exportFormat!=='wav'){
    try{
      const mimeMap={'webm-mp3':'audio/webm;codecs=opus','ogg':'audio/ogg;codecs=opus','flac-wav':'audio/wav'};
      const mime=mimeMap[exportFormat]||'audio/webm';
      if(MediaRecorder.isTypeSupported(mime)||MediaRecorder.isTypeSupported('audio/webm')){
        const offlineAudio=new Audio();
        offlineAudio.src=URL.createObjectURL(wav);
        const streamCtx=getAC();
        const streamSrc=streamCtx.createBufferSource();
        streamSrc.buffer=rendered;
        const streamDest=streamCtx.createMediaStreamDestination();
        streamSrc.connect(streamDest);
        const finalMime=MediaRecorder.isTypeSupported(mime)?mime:'audio/webm';
        const mr=new MediaRecorder(streamDest.stream,{mimeType:finalMime});
        const chunks=[];
        mr.ondataavailable=e=>chunks.push(e.data);
        const done=new Promise(res=>mr.onstop=res);
        mr.start(); streamSrc.start(0);
        streamSrc.onended=()=>mr.stop();
        await done;
        blob=new Blob(chunks,{type:finalMime});
        ext=exportFormat==='ogg'?'ogg':'webm';
      }
    }catch(e){ console.warn('Fallback to WAV'); }
  }

  fill.style.width='100%'; status.textContent='¬°Completado!';
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${name}.${ext}`; a.click();
  URL.revokeObjectURL(url);
  setTimeout(()=>{ document.getElementById('export-modal').classList.remove('show'); prog.style.display='none'; fill.style.width='0'; status.textContent=''; notify('‚úì Archivo exportado: '+name+'.'+ext,'success'); },800);
}

function bufToWav(buf){
  const nCh=buf.numberOfChannels, sr=buf.sampleRate, n=buf.length;
  const bps=2, bl=nCh*bps, dataSize=n*bl;
  const ab=new ArrayBuffer(44+dataSize);
  const v=new DataView(ab);
  const ws=(o,s)=>{ for(let i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i)); };
  ws(0,'RIFF'); v.setUint32(4,36+dataSize,true); ws(8,'WAVE'); ws(12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nCh,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*bl,true); v.setUint16(32,bl,true);
  v.setUint16(34,16,true); ws(36,'data'); v.setUint32(40,dataSize,true);
  let off=44;
  for(let i=0;i<n;i++) for(let c=0;c<nCh;c++){
    const s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i]));
    v.setInt16(off,s<0?s*0x8000:s*0x7FFF,true); off+=2;
  }
  return new Blob([ab],{type:'audio/wav'});
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e=>{
  if(e.target.matches('input,textarea,[contenteditable]')) return;
  switch(e.code){
    case 'Space': e.preventDefault(); if(isPlaying)pause(); else play(); break;
    case 'Home': stop(); break;
    case 'Delete': case 'Backspace':
      if(selectedClipId){
        for(const t of tracksData){ const c=t.clips.find(c=>c.id===selectedClipId); if(c){removeClip(t,c.id);break;} }
      } break;
    case 'KeyZ': if(e.ctrlKey||e.metaKey) notify('Undo no disponible a√∫n','error'); break;
    case 'Equal': case 'NumpadAdd': changeBpm(e.shiftKey?10:1); break;
    case 'Minus': case 'NumpadSubtract': changeBpm(e.shiftKey?-10:-1); break;
    case 'KeyL': isLooping=!isLooping; document.getElementById('btn-loop').classList.toggle('on',isLooping); break;
    case 'KeyM': if(selectedClipId){ /* mute clip */ } break;
  }
});

// ‚îÄ‚îÄ‚îÄ NOTIFY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function notify(msg, type=''){
  const el=document.getElementById('notif');
  el.textContent=msg; el.className='notif show '+(type||'');
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.className='notif',2800);
}
function setStatus(msg){ document.getElementById('status-bar').textContent=msg; }

// ‚îÄ‚îÄ‚îÄ PERIODIC VU (even when paused) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(()=>{
  if(!isPlaying) updateMeters();
  drawRuler();
}, 150);

// ‚îÄ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', ()=>{ drawRuler(); if(clipEditorClip) drawClipEditorWave(clipEditorClip.clip); });

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init(){
  initKnobs();
  initLibrary();
  drawRuler();

  // Create default tracks with demo clips
  ensureGraph();
  const t1=createTrack('DRUMS');
  const t2=createTrack('BASS');
  const t3=createTrack('SYNTH');
  const t4=createTrack('MELODY');

  const beat=60/bpm;
  // Drums pattern
  const kickBuf=SAMPLES['Kick 808']();
  const snareBuf=SAMPLES['Snare Crack']();
  const hatBuf=SAMPLES['Hi-Hat Closed']();
  const hatoBuf=SAMPLES['Hi-Hat Open']();
  for(let i=0;i<8;i+=2){ addClip(t1,kickBuf,'Kick 808',i*beat,t1.color); }
  for(let i=1;i<8;i+=2){ addClip(t1,snareBuf,'Snare',i*beat,t1.color); }
  for(let i=0;i<16;i++){ addClip(t1,(i%4===3)?hatoBuf:hatBuf,'Hat',i*beat*0.5,t1.color); }

  // Bass
  addClip(t2,SAMPLES['Bass Sub 808'](),'Bass 808',0,t2.color);
  addClip(t2,SAMPLES['Bass Pluck'](),'Bass Pluck',beat*4,t2.color);
  addClip(t2,SAMPLES['Bass Sub 808'](),'Bass 808',beat*8,t2.color);

  // Synth
  addClip(t3,SAMPLES['Synth Pad'](),'Pad',0,t3.color);
  addClip(t3,SAMPLES['Chord Major'](),'Chord Maj',beat*2,t3.color);
  addClip(t3,SAMPLES['Chord Minor'](),'Chord Min',beat*6,t3.color);
  addClip(t3,SAMPLES['FX Riser'](),'Riser',beat*6.5,t3.color);

  // Melody
  addClip(t4,SAMPLES['Synth Lead'](),'Lead',beat,t4.color);
  addClip(t4,SAMPLES['Arp 1'](),'Arp',beat*3,t4.color);
  addClip(t4,SAMPLES['Synth Lead'](),'Lead',beat*5,t4.color);
  addClip(t4,SAMPLES['Synth Stab'](),'Stab',beat*7,t4.color);

  renderMixer();
  notify('¬°Bienvenido a STERLING MIX PRO! Usa la Librer√≠a o arrastra tus archivos de audio.','success');
}

init();
</script>
</body>
</html> 
